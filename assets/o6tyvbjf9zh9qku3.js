var F=Object.defineProperty,z=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var C=Object.getOwnPropertySymbols;var H=Object.prototype.hasOwnProperty,L=Object.prototype.propertyIsEnumerable;var T=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e);var P=(e,t,r)=>t in e?F(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,$=(e,t)=>{for(var r in t||(t={}))H.call(t,r)&&P(e,r,t[r]);if(C)for(var r of C(t))L.call(t,r)&&P(e,r,t[r]);return e},j=(e,t)=>z(e,G(t));var v=function(e,t){this[0]=e,this[1]=t},O=(e,t,r)=>{var a=(m,s,i,l)=>{try{var S=r[m](s),f=(s=S.value)instanceof v,c=S.done;Promise.resolve(f?s[0]:s).then(n=>f?a(m==="return"?m:"next",s[1]?{done:n.done,value:n.value}:n,i,l):i({value:n,done:c})).catch(n=>a("throw",n,i,l))}catch(n){l(n)}},o=m=>u[m]=s=>new Promise((i,l)=>a(m,s,i,l)),u={};return r=r.apply(e,t),u[T("asyncIterator")]=()=>u,o("next"),o("throw"),o("return"),u};var w=(e,t,r)=>(t=e[T("asyncIterator")])?t.call(e):(e=e[T("iterator")](),t={},r=(a,o)=>(o=e[a])&&(t[a]=u=>new Promise((m,s,i)=>(u=o.call(e,u),i=u.done,Promise.resolve(u.value).then(l=>m({value:l,done:i}),s)))),r("next"),r("return"),t);import{o as U,m as V}from"./g5lgy1otfli5p2x7.js";import{am as W,dv as X,cF as Y,a_ as x,bq as B}from"./ghewn7l2ynbm32fm.js";import{hn as Q,dV as J}from"./j0yo6uv6652vva62.js";import{r as d,e as N,u as Z}from"./i8clt0mfz495j7ii.js";function I(e){const t=d.useMemo(()=>e.join("\0"),[e]);return d.useMemo(()=>e,[t])}const ee=["task_turn_event","work_log_message","log","task_title_generated","rollout_event","app_server_event"];function me(e,t,r){"use no forget";const a=N(),[o,u]=d.useState(r?a.formatMessage({id:"wham.useStreamTurn.preparingTask",defaultMessage:"Working on your task"}):""),[m,s]=d.useState(o);d.useEffect(()=>{const l=X(()=>s(o),200);return l(),l.cancel},[o]);const i=d.useMemo(()=>"last-event-".concat(e,"-").concat(r!=null?r:"","-").concat(Math.random().toString(36).slice(2)),[e,r]);return te(e,r,["task_turn_event"],{enabled:!!r&&!U(t),subscriberId:i,onEvent:l=>u(l.task_turn_event.text)}),m}function te(e,t,r,{enabled:a=!0,subscriberId:o,onEvent:u,onComplete:m}){"use no forget";const s=Q(u),i=Q(m),l=I(r),S=Z(),f=d.useCallback(n=>{s.current(n)},[s]),c=d.useCallback(()=>{var n;(n=i.current)==null||n.call(i)},[i]);d.useEffect(()=>{if(!(!t||!a))return K.retainTurnStream(S,e,t,o,l,f,c),()=>{K.releaseTurnStream(e,t,o)}},[e,t,o,l,a,S,f,c])}function re(o){return O(this,arguments,function*({taskId:e,turnId:t,abortSignal:r,types:a}){let m="".concat(window.location.origin+"/backend-api","/wham/tasks/").concat(e,"/turns/").concat(t,"/stream");if(a.length>0){const c=a.map(n=>"item_type=".concat(encodeURIComponent(n))).join("&");m+="?".concat(c)}const s=J(m,{method:"GET",signal:r,headers:j($({},Y({isAuthOptional:!1})),{"Content-Type":"text/event-stream"}),observer:{onClose:(c,n)=>{if(n&&!k(n))throw n}}});try{try{for(var i=w(s),l,S,f;l=!(S=yield new v(i.next())).done;l=!1){const c=S.value;const n=ne(c);n&&(!a||a.includes(n.item_type)?yield n:x.warn("Unknown event type",{event:c}))}}catch(S){f=[S]}finally{try{l&&(S=i.return)&&(yield new v(S.call(i)))}finally{if(f)throw f[0]}}}catch(c){if(k(c))return;throw c}})}function ne(e){return!("data"in e)||!e.data||e.event==="heartbeat"?null:e.data}function k(e){return!!e&&typeof e=="object"&&e.name==="AbortError"}const D=W(B(()=>({turnStreams:{}}))),A=D.getState,g=D.setState;function R(e,t){return"".concat(e,":").concat(t)}const q=20;function se(e,t,r,a){var u,m;let o;return g(s=>{const i=s.turnStreams[t];if(!i)return;if(i.initPromise){o=i.initPromise;return}const{abortController:l}=i,f=(async()=>{var M;let c=0;const n=b=>{const E=[];g(h=>{const y=h.turnStreams[t];y&&(y.seenEventIds.has(b.id)||(y.seenEventIds.add(b.id),y.emittedEvents.push(b),Object.values(y.subscribers).forEach(p=>{if(!p.types.includes(b.item_type))return;const _=p.lastTimestamps[b.item_type];_&&b.timestamp<=_||(p.lastTimestamps[b.item_type]=b.timestamp,E.push(p.onEvent))})))}),E.forEach(h=>h(b))};for(;!l.signal.aborted&&c<q;){try{const p=re({taskId:r,turnId:a,abortSignal:l.signal,types:ee});try{for(var Se=w(p),pe,he,de;pe=!(he=await Se.next()).done;pe=!1){const _=he.value;if(l.signal.aborted)break;n(_)}}catch(he){de=[he]}finally{try{pe&&(he=Se.return)&&await he.call(Se)}finally{if(de)throw de[0]}}}catch(p){if(k(p)||l.signal.aborted)break}const b=V(r,a),E=await e.fetchQuery(b),h=U(E.turn.turn_status);if(h&&await Promise.all([e.refetchQueries({queryKey:["wham","task",r]}),e.invalidateQueries({queryKey:["wham","tasks"]})]),c+=1,c>=q||l.signal.aborted||h)break;const y=Math.min(16e3,1e3*2**c)+Math.random()*500;await new Promise(p=>setTimeout(p,y))}if(!l.signal.aborted){const b=(M=A().turnStreams[t])==null?void 0:M.subscribers;Object.values(b!=null?b:{}).forEach(E=>{var h;(h=E.onComplete)==null||h.call(E)})}})().finally(()=>{g(c=>{const n=c.turnStreams[t];n&&n.initPromise===f&&(n.initPromise=null,Object.keys(n.subscribers).length||delete c.turnStreams[t])})});i.initPromise=f,o=f}),(m=o!=null?o:(u=A().turnStreams[t])==null?void 0:u.initPromise)!=null?m:Promise.resolve()}const K={async retainTurnStream(e,t,r,a,o,u,m){const s=R(t,r);let i=!1;g(S=>{let f=S.turnStreams[s];f?f.initPromise||(i=!0,f.abortController=new AbortController):(i=!0,f={subscribers:{},abortController:new AbortController,initPromise:null,emittedEvents:[],seenEventIds:new Set},S.turnStreams[s]=f);const c=f.subscribers[a];c?(c.types=Array.from(o),c.onEvent=u,c.onComplete=m):f.subscribers[a]={subscriberId:a,types:Array.from(o),onEvent:u,onComplete:m,lastTimestamps:{}}});const l=A().turnStreams[s].emittedEvents;for(const S of l)o.includes(S.item_type)&&u(S);i&&await se(e,s,t,r)},releaseTurnStream(e,t,r){const a=R(e,t);let o=!1,u;g(m=>{const s=m.turnStreams[a];!s||!s.subscribers[r]||(delete s.subscribers[r],Object.keys(s.subscribers).length||(o=!0,u=s.abortController,delete m.turnStreams[a]))}),o&&u&&u.abort()}};function le(e,t){return!e||e.length<=t?e:e.slice(0,t/2)+"â€¦"+e.slice(-t/2)}export{te as a,k as i,le as m,me as u};
//# sourceMappingURL=o6tyvbjf9zh9qku3.js.map
