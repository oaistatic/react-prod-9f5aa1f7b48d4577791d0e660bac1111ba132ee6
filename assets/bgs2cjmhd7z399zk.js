import{r as o,u as B,e as I,h as L,d as K,j as c,ai as O,k as U,ab as q,A as N}from"./i8clt0mfz495j7ii.js";import{j4 as z,e as H,pT as Q,f5 as $}from"./ghewn7l2ynbm32fm.js";import{W as G}from"./ky1286q3ol03v4z1.js";import{z as J,A as V,l as X,W as Y,o as Z,v as D,B as ee}from"./g5lgy1otfli5p2x7.js";import{ci as te,aC as P,aD as F}from"./j0yo6uv6652vva62.js";import{u as re}from"./ivhm4b1s5w1b1cuw.js";import{useSetupBaseWhamKeyboardActions as oe}from"./hem935dboxz5ici0.js";import{b as ne,g as se,T as ue,W as ae,c as ie}from"./ou9nacxkrsdx0eej.js";import{u as me}from"./bzqztn8malpuegtc.js";import"./ktw3b87sujui39wx.js";import"./nrrhfi0a0bbsg9w2.js";import"./ozgq3nk5vhninx80.js";import"./i94vqq9eycryltby.js";import"./pn83wqr6w775mq4b.js";import"./chs4g5r39qlnqw6r.js";import"./nzsqhqpna1ee8hwf.js";import"./eh21clr7cewe9q6y.js";import"./gutjuo0v1j4y19t1.js";import"./c80gqv0732s10rnu.js";import"./g69peh4qbpo7a7d7.js";import"./ieykhlrsk25lij4e.js";import"./i03gut32e8jn5ajq.js";import"./h1em0bjkpkjv8ykw.js";import"./e26n6uhwwtwdmiki.js";import"./mjq17q47489shd3e.js";import"./hxdh3tr5l8kut4ed.js";import"./hu1bt0oauegdhua6.js";import"./jo0yr7ku7v9ac6ge.js";import"./kq8d654gegx6snmr.js";import"./zul7780usssm7kro.js";import"./i84uy1p9ly5pjwpt.js";import"./o6tyvbjf9zh9qku3.js";import"./lptwpbjabrvjmhsj.js";import"./gf67njbmurwfkel2.js";import"./dntm9op0tz5bndrs.js";import"./fzrn137102spawew.js";import"./eflwd0j5c3pxruh8.js";import"./l2r1du6tfxyv7jaj.js";import"./ln88gzx578175chd.js";import"./fr2n5yqcoayleu1k.js";import"./ghnvrdqxofgwprfv.js";import"./mqebxepg7t6q2tie.js";import"./abaiei0at0999ntu.js";import"./cgpsp6f7jvechnd8.js";import"./hf1acpjenvjtaqkn.js";import"./gzhyo73bmtx9f3d9.js";import"./o56jrqjpjpipvc65.js";import"./hfx63ilakvlo6bm4.js";import"./1u88i8jf4mwk3mc5.js";function ce(){return o.useSyncExternalStore(t=>(document.addEventListener("focusin",t),document.addEventListener("focusout",t),()=>{document.removeEventListener("focusin",t),document.removeEventListener("focusout",t)}),()=>{var t;return typeof document<"u"&&((t=document.activeElement)==null?void 0:t.hasAttribute("data-wham-comment-textarea"))===!0},()=>!1)}function de(t){var b,T,k,_,h,w,W;const a=B(),i=z(),m=ce(),{data:e,error:p}=J(t,{refetchOnWindowFocus:!0,refetchOnMount:!0}),{isLoading:d}=V(t),n=X(o.useCallback(({getTurnsForTask:s})=>{var u;return(u=s(t))!=null?u:[]},[t])),{focusedAssistantTurn:r,setFocusedAssistantTurnId:j}=ne({taskId:t,task:e==null?void 0:e.task,currentUserTurn:(b=e==null?void 0:e.current_user_turn)!=null?b:null,currentAssistantTurn:(T=e==null?void 0:e.current_assistant_turn)!=null?T:null}),y=o.useMemo(()=>{var s,u;return se({focusedAssistantTurn:r,pastTurns:n,currentDiffTaskTurnId:(u=(s=e==null?void 0:e.current_diff_task_turn)==null?void 0:s.id)!=null?u:null})},[r,(k=e==null?void 0:e.current_diff_task_turn)==null?void 0:k.id,n]),l=(_=e==null?void 0:e.task)==null?void 0:_.current_turn_id,C=!!(e!=null&&e.task.has_unread_turn)&&l===((h=e==null?void 0:e.current_assistant_turn)==null?void 0:h.id),g=((w=e==null?void 0:e.current_assistant_turn)==null?void 0:w.turn_status)==="completed";o.useEffect(()=>{var f;if(!i)return;const s=(f=e==null?void 0:e.task)==null?void 0:f.title;if(!s)return;const u=document.title;return document.title=s,()=>{document.title=u}},[i,(W=e==null?void 0:e.task)==null?void 0:W.title]),o.useEffect(()=>{!C||!g||Y.markTurnAsRead(t).then(()=>{a.invalidateQueries({queryKey:["wham","tasks"]}),a.invalidateQueries({queryKey:["wham","task",t]})})},[C,g,t,a]);const M=o.useMemo(()=>{var E,x,S,v;const s=r?Z(r.turn_status):!1,u=((S=r==null?void 0:r.sibling_turn_ids)==null?void 0:S.includes((x=(E=e==null?void 0:e.current_assistant_turn)==null?void 0:E.id)!=null?x:""))||(r==null?void 0:r.id)===((v=e==null?void 0:e.current_assistant_turn)==null?void 0:v.id),f=!(e!=null&&e.current_diff_task_turn);return s&&(u||f)},[r,e==null?void 0:e.current_assistant_turn,e==null?void 0:e.current_diff_task_turn]);return{taskDetails:e,taskDetailsError:p,loadingTurnMapping:d,turns:n,focusedAssistantTurn:r,setFocusedAssistantTurnId:j,currentDiffTaskTurn:y,canFollowUp:M,isCommentFocused:m}}function pe(){const[t,a]=o.useState([]),[i,m]=o.useState(!1),e=o.useCallback(()=>{a([])},[]),p=o.useCallback(({onClose:d,isComposerEmpty:n})=>({force:r=!1}={})=>{if(r||t.length===0&&n){e(),d();return}m(!0)},[t.length,e]);return{comments:t,setComments:a,confirmClose:i,setConfirmClose:m,clearComments:e,createCloseHandler:p}}function le({taskId:t,onClose:a}){"use no forget";var v,A;const i=H(),m=I(),e=L(),{composerController:p,isComposerEmpty:d}=me(),{taskDetails:n,taskDetailsError:r,loadingTurnMapping:j,turns:y,focusedAssistantTurn:l,currentDiffTaskTurn:C,setFocusedAssistantTurnId:g,canFollowUp:M,isCommentFocused:b}=de(t),T=o.useMemo(()=>D(l),[l]),k=o.useMemo(()=>({taskId:t,task:n==null?void 0:n.task,pastTurns:y,canFollowUp:M,focusedAssistantTurn:l,currentDiffTaskTurn:C,setFocusedAssistantTurnId:g}),[t,n,y,M,l,C,g]),{comments:_,setComments:h,confirmClose:w,setConfirmClose:W,clearComments:s,createCloseHandler:u}=pe(),f=o.useMemo(()=>({comments:_,setComments:h,clearComments:s,readonlyComments:T}),[_,h,s,T]),E=te.useCurrentImage()!=null,x=u({onClose:a,isComposerEmpty:d});oe(),re([{key:"newTask",action:()=>{e("/codex",{state:{focusComposer:!0}})},actionMessageDescriptor:m.formatMessage({id:"wham.keyboardActions.newTask",defaultMessage:"New task"}),group:F.Chat,keyboardBinding:[P.Mod,P.Shift,"o"]},{key:"closeTask",action:()=>{e("/codex")},actionMessageDescriptor:m.formatMessage({id:"wham.keyboardActions.closeTask",defaultMessage:"Close task"}),group:F.Chat,keyboardBinding:[P.Escape],enabled:!E&&!b}]);const S=o.useCallback(({force:R=!1}={})=>{x({force:R})},[x]);return r?(i.danger(K({id:"wham.task-details.error",defaultMessage:"Error loading task"}),{id:"wham-task-details-error-".concat(t),hasCloseButton:!0,duration:3,toastId:"wham_task_page_content_error"}),c.jsx(O,{to:"/codex"})):c.jsx(Q.Provider,{value:p,children:c.jsx(ue,{value:f,children:c.jsx(ae,{value:k,children:c.jsx(ie,{permissions:"write",turnId:(A=(v=n==null?void 0:n.current_assistant_turn)==null?void 0:v.id)!=null?A:"",confirmClose:w,setConfirmClose:W,handleClose:S,loadingTurnMapping:j})})})})}function fe(){var d;const t=L(),a=U(),{taskId:i}=q();ee();const m=(d=a.state)!=null?d:{},{backgroundLocation:e}=m,p=o.useCallback(()=>{t(e?-1:"/codex")},[e,t]);return i?c.jsx($,{children:c.jsx(G,{children:c.jsx(le,{taskId:i,onClose:p})})}):null}const ct=()=>[{title:"Codex"}],dt=N(function(){return c.jsx(fe,{})});export{dt as default,ct as meta};
//# sourceMappingURL=bgs2cjmhd7z399zk.js.map
