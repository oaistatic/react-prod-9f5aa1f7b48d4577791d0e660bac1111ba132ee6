const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ghewn7l2ynbm32fm.js","assets/i8clt0mfz495j7ii.js","assets/root-c4psboex.css","assets/c8sj5q0wb2w4qlno.js"])))=>i.map(i=>d[i]);
var Z=Object.defineProperty,X=Object.defineProperties;var Q=Object.getOwnPropertyDescriptors;var B=Object.getOwnPropertySymbols;var Y=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var L=(e,r,t)=>r in e?Z(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,A=(e,r)=>{for(var t in r||(r={}))Y.call(r,t)&&L(e,t,r[t]);if(B)for(var t of B(r))ee.call(r,t)&&L(e,t,r[t]);return e},D=(e,r)=>X(e,Q(r));import{r as n,e as te,an as re,j as f,M as T,_ as $}from"./i8clt0mfz495j7ii.js";import{J as G,d7 as ne,cG as se,kZ as I,$ as P,o as V,d as j,b0 as U,L as H,jA as oe,P as ce,S as ae}from"./ghewn7l2ynbm32fm.js";import{kK as J,kL as N,kM as q}from"./j0yo6uv6652vva62.js";function C(e,r){return t=>{G.addAction("".concat(e,".").concat(r),t)}}function ie(e){return(r,t)=>{G.addError(r,D(A({},t),{name:e,status:"error"}))}}const S={recording:{start:C("whisper-recording","start"),cancel:C("whisper-recording","cancel"),submit:C("whisper-recording","submit")},transcription:{request:C("whisper-transcription","request"),transcriptDelivered:C("whisper-transcription","transcriptDelivered"),error:ie("whisper-transcription"),requestSuccess:C("whisper-transcription","requestSuccess")}};class ue{static async transcribe(r,t,b={}){const w=new FormData;w.append("file",r),t&&w.append("language",t);const h={durationMs:b.durationMs,language:t,fileSize:r.size},g=performance.now();return S.transcription.request(h),ne.post("".concat(se,"/transcribe"),w).then(o=>{const c=performance.now()-g;return S.transcription.requestSuccess(D(A({},h),{durationMs:c})),o}).catch(o=>{const c=performance.now()-g;throw S.transcription.error(o,D(A({},h),{durationMs:c})),o})}}const le=48e3,de=10,W=le*de,pe=4e3,fe=600*1e3,v=e=>J.setState(r=>{r.status=e}),ge=e=>{const r=n.useRef(e);r.current=e;const t=n.useRef(null),b=n.useRef([]),w=n.useRef(null),h=n.useRef(null),g=n.useRef(null),o=n.useRef(new Float32Array(0)),c=n.useRef(null),M=n.useRef(null),y=n.useRef(!1),i=n.useCallback(()=>{o.current=new Float32Array,r.current.onWaveformDataUpdate(void 0)},[]),E=n.useCallback(async(u,m)=>{var p;v("transcribing");try{let l;I()?l=new File([u],"whisper.mp3",{type:"audio/mpeg"}):l=new File([u],"whisper.".concat(u.type.split(/[\/;]/)[1]||"mp3"),{type:u.type});const a=await ue.transcribe(l,void 0,{durationMs:m});v("idle"),S.transcription.transcriptDelivered({durationMs:m,transcriptLength:a.text.length}),r.current.onSuccess(a.text,a.asset_pointer,a.asset_ttl,(p=a.asset_format)!=null?p:null),i()}catch(l){v("error"),S.transcription.error(l,{durationMs:m}),i()}},[i]),R=n.useCallback(u=>{var p,l,a,d,s;if(!y.current)return;y.current=!1,M.current!==null&&(clearTimeout(M.current),M.current=null);const m=c.current!=null?performance.now()-c.current:void 0;u&&t.current&&(t.current.ondataavailable=null,t.current.onstop=null,v("idle"),i(),S.recording.cancel({durationMs:m}),c.current=null),(p=t.current)==null||p.stop(),(l=t.current)==null||l.stream.getTracks().forEach(k=>k.stop()),t.current=null,(a=g.current)==null||a.disconnect(),g.current=null,(d=h.current)==null||d.disconnect(),h.current=null,(s=w.current)==null||s.close(),w.current=null,u||S.recording.submit({durationMs:m})},[i]),F=n.useCallback(()=>{i(),v("recording"),navigator.mediaDevices.getUserMedia({audio:{sampleRate:pe,channelCount:1}}).then(u=>{c.current=performance.now(),S.recording.start(),t.current=new MediaRecorder(u);const m=I();y.current=!0,m?(b.current=[],t.current.ondataavailable=d=>{d.data.size>0&&b.current.push(d.data)},t.current.onstop=async()=>{const d=new Blob(b.current,{type:"audio/mpeg-3"}),s=c.current!=null?performance.now()-c.current:void 0;await E(d,s)},t.current.start(1e3)):(t.current.ondataavailable=async d=>{const s=c.current!=null?performance.now()-c.current:void 0;await E(d.data,s)},t.current.start()),o.current=new Float32Array(W).fill(r.current.initialValue),r.current.onWaveformDataUpdate(o.current),v("recording"),M.current=window.setTimeout(()=>{R()},fe);const p=new AudioContext;w.current=p;const l=p.createMediaStreamSource(u);h.current=l;const a=p.createScriptProcessor(2048,1,1);g.current=a,a.onaudioprocess=d=>{const s=d.inputBuffer.getChannelData(0);for(let x=0;x<s.length;x++)s[x]=Math.max(s[x],r.current.initialValue);const k=o.current,_=new Float32Array(k.length+s.length);if(_.set(k,0),_.set(s,k.length),_.length>W){const x=_.length-W;o.current=_.slice(x)}else o.current=_;r.current.onWaveformDataUpdate(o.current)},l.connect(a),a.connect(p.destination)}).catch(()=>{v("error"),i(),S.recording.cancel()})},[i,R,E]);return n.useEffect(()=>()=>{R(!0)},[R]),{startRecording:F,stopRecording:R}},z=V(()=>$(()=>import("./ghewn7l2ynbm32fm.js").then(e=>e.vJ),__vite__mapDeps([0,1,2])),{loading:e=>H(e)}),O=V(()=>$(()=>import("./c8sj5q0wb2w4qlno.js").then(e=>e._),__vite__mapDeps([3,1])),{loading:e=>H(e)});function Se({disabled:e=!1,initialValue:r,onSuccess:t,onWaveformDataUpdate:b,onExit:w,buttonClassName:h,visualTreatment:g}){const o=te(),c=J(s=>s.status),M=n.useRef(!1),{startRecording:y,stopRecording:i}=ge({onSuccess:t,onWaveformDataUpdate:b,initialValue:r}),E=re();n.useEffect(()=>()=>{i()},[i]),n.useEffect(()=>{M.current||(y(),M.current=!0)},[y]),n.useEffect(()=>{E.state!=="idle"&&i()},[E.state,i]);const R=()=>{i(!0),w()},F=g==="codex"?f.jsx(P,{type:"button",color:"ghost",size:"small",onClick:R,icon:z,disabled:e||c==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},children:f.jsx(T,{id:"wham.whisperModeControls.cancel",defaultMessage:"Cancel"})}):f.jsx("div",{children:f.jsx("button",{"aria-label":o.formatMessage({id:"RMraLB",defaultMessage:"Stop dictation"}),type:"button",onClick:R,disabled:e||c==="transcribing",style:{viewTransitionName:"--vt-composer-whisper-button"},className:j(g==="composer-btn"?"composer-btn":j(N,e?"opacity-30":q,h)),children:f.jsx(z,{"aria-label":o.formatMessage({id:"DFGZS4",defaultMessage:"Stop dictation"}),className:"icon",fontSize:"inherit"})})}),u=c==="transcribing",m=u?f.jsx(U,{}):f.jsx(O,{className:"icon-lg"}),p=u?o.formatMessage({id:"CyAAys",defaultMessage:"Transcribing dictation"}):o.formatMessage({id:"fcPx42",defaultMessage:"Submit dictation"}),l=()=>{ce.logEvent("Whisper on Web/Windows: Clicked to end dictation"),ae.logEvent("chatgpt_composer_whisper_button_clicked_end"),i()},a=s=>{s.key==="Escape"&&oe(s)&&(R(),s.preventDefault())},d=g==="codex"?f.jsx(P,{type:"button",color:"secondary",size:"small",disabled:e,icon:u?U:O,onClick:l,onKeyDown:a,ref:K,children:f.jsx(T,{id:"wham.whisperModeControls.done",defaultMessage:"Done"})}):f.jsx("div",{children:f.jsx("button",{type:"button","aria-label":p,disabled:e,className:g==="composer-btn"?"composer-btn":j(N,e?"opacity-30":q,h),onClick:l,onKeyDown:a,ref:K,children:m})});return f.jsxs("div",{className:"flex gap-x-1.5",children:[F,d]})}function K(e){e==null||e.focus()}export{Se as WhisperModeControls};
//# sourceMappingURL=i8srkfobxvgw8sgj.js.map
