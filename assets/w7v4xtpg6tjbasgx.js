const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/mtsfsh7z74bmo6ig.js","assets/i8clt0mfz495j7ii.js","assets/f2itj05whsmn3kgs.js","assets/mbhfxri3syrb9rbq.js","assets/iuuhyyi1fiiwu4me.js","assets/j0yo6uv6652vva62.js","assets/ghewn7l2ynbm32fm.js","assets/root-c4psboex.css","assets/conversation-small-lq38g8zw.css","assets/gkuhfrmysvpuw4uo.js","assets/ghnvrdqxofgwprfv.js","assets/mh1u90j45tiq86ol.js","assets/hht3m8p9e0s4tqnx.js","assets/kgnykbdth8mb50na.js","assets/g8i6bixylsxyemsr.js","assets/ktw3b87sujui39wx.js","assets/nrrhfi0a0bbsg9w2.js"])))=>i.map(i=>d[i]);
var je=Object.freeze,Qe=Object.defineProperty;var ke=(e,t)=>je(Qe(e,"raw",{value:je(t||e.slice())}));import{j as n,e as X,h as Ye,r as i,_ as ne,u as Oe,m as Xe,c as Pe}from"./i8clt0mfz495j7ii.js";import{aV as Q,d as W,$ as Ze,a1 as et,bk as tt,x as ye,jE as Me,t9 as nt,lj as Re,iC as at,jF as Ce,u as ue,B as st,a0 as it,a4 as Be,aW as ot,o as ae,F as rt,L as de,ba as ct,b1 as ze,gX as lt,gJ as ut,gK as dt,j as mt,J as re,cH as gt,cI as ft,P as ht,bO as ce,bQ as Fe,R as xt,bT as It,bY as _t,bN as wt,a as Ne,e as vt,iA as St,p5 as pt,dj as bt,dM as jt}from"./ghewn7l2ynbm32fm.js";import{I as ie,D as He,u as kt}from"./emrxz4v8n4klxny6.js";import{aR as yt,sO as Mt,ig as Rt,ih as Ct,u4 as Nt,dT as Y,d7 as Et,u5 as Gt,u6 as At,u7 as Tt,bw as Ve,dU as $e,u8 as Dt,u9 as k,ua as Ut,hH as le,ub as Ot,uc as Ee,ud as Bt,ue as zt}from"./j0yo6uv6652vva62.js";import{C as qe}from"./o56jrqjpjpipvc65.js";import{D as Ft}from"./lktqd4c5dfo8cx5l.js";import{C as Ht}from"./gla0jqw9ed8nrnoj.js";import"./pbvsc3do5o365cxq.js";import"./hk7ym2rzlomukbdz.js";const We=({children:e,isDimensionsUnknown:t})=>n.jsxs(Q.div,{className:W(["relative max-w-[480px] rounded-2xl",t&&"aspect-square overflow-hidden"]),children:[n.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),n.jsx("div",{className:"relative h-full",children:e})]}),Vt=({children:e,isDimensionsUnknown:t,width:s,height:a})=>n.jsxs(Q.div,{layout:!0,transition:{duration:.3,ease:"easeInOut"},exit:{opacity:0,transition:{duration:.1,ease:"easeInOut"}},className:W(["relative max-w-[480px] overflow-hidden rounded-2xl",t&&"aspect-square"]),style:{width:s!=null?s:"auto",height:a!=null?a:"auto"},children:[n.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),n.jsx("div",{className:"relative h-full",children:e})]}),$t=()=>{const e=X(),t=Ye();return n.jsxs("div",{className:"absolute start-0 bottom-0 flex w-full items-center justify-between bg-white/10 p-4",children:[n.jsxs("div",{className:"flex min-w-0 flex-col",children:[n.jsx("span",{className:"text-sm font-medium text-white",children:e.formatMessage({id:"PlfJ+x",defaultMessage:"Creation might take a moment"})}),n.jsx("span",{className:"text-sm font-normal text-white/80",children:e.formatMessage({id:"4JG8yC",defaultMessage:"Upgrade to create faster"})})]}),n.jsx(Ze,{size:"medium",color:"primary-inverse",onClick:()=>yt(t,"Image Gen Latency Upsell"),children:e.formatMessage(et.getPlus)})]})};function qt(e){const[t,s]=tt(ye.ImageGenProgressUpsellV2,null,o=>o!=null&&typeof o=="object"&&(typeof o.lastSeenUpsellAt=="number"||o.lastSeenUpsellAt==null)&&(typeof o.lastUsedImageGen=="number"||o.lastUsedImageGen==null)&&(typeof o.lastMessageId=="string"||o.lastMessageId==null)&&(typeof o.lastCanBeSeen=="boolean"||o.lastCanBeSeen==null)),a=t&&t.lastSeenUpsellAt?Me(t.lastSeenUpsellAt):null,r=t&&t.lastUsedImageGen?Me(t.lastUsedImageGen):null,l=e?t&&t.lastMessageId===e?t.lastCanBeSeen:(a==null||nt(a,Re(new Date,3)))&&r!=null&&at(r,Re(new Date,1)):!1;return{canBeSeen:l,markImageGenUsed:()=>{var o;if(e){const h={lastSeenUpsellAt:l?Ce(new Date):(o=t==null?void 0:t.lastSeenUpsellAt)!=null?o:null,lastUsedImageGen:Ce(new Date),lastMessageId:e!=null?e:null,lastCanBeSeen:l};s(h),localStorage.setItem(ye.ImageGenProgressUpsellV2,JSON.stringify(h))}}}}function Wt(){const[t,s]=i.useState(new Date);i.useEffect(()=>{s(new Date)},[]);const a=Rt(+t,12e4);return n.jsx(Ct,{percentage:a,sizeOverride:30,thickness:1/15,className:"text-white",backgroundStrokeClassName:"stroke-white/20",transitionDuration:"".concat((100-a)/100*.2,"s"),transitionTimingFunction:"cubic-bezier(0.55, 0, 1, 1)"})}const Ke=({isGettingStarted:e,messageId:t})=>{var d;const s=ue(),a=st(),r=(d=a==null?void 0:a.isFree())!=null?d:!1,{canBeSeen:l,markImageGenUsed:c}=qt(t),o=r&&l&&it(s,"1997515563").get("should_show_image_gen_latency_upsell",!1);Mt(()=>{c()});const h=X(),m=i.useMemo(()=>e?h.formatMessage({id:"SxQKjt",defaultMessage:"Getting started"}):h.formatMessage({id:"Y3ETLn",defaultMessage:"Creating image"}),[e,h]),u=Be(s,"3019066937").get("should_show_cot_header",!1),g=i.useMemo(()=>e?n.jsx(qe,{size:30,arcPercentage:.2,strokeWidth:2}):n.jsx(Wt,{}),[e]);return n.jsxs("div",{className:W("absolute inset-0 flex justify-between px-6 py-6",o?"items-start":"items-end"),children:[n.jsxs(ot,{mode:"popLayout",children:[u&&n.jsx(Q.span,{className:W("flex items-center gap-1 align-middle text-lg",!e&&"text-white"),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,overflow:"hidden",whiteSpace:"nowrap"},transition:{duration:.1,ease:"easeInOut"},children:m},m),n.jsx("div",{className:"flex flex-1 items-center justify-end",children:g})]}),o&&n.jsx($t,{})]})},Kt=ae(()=>ne(()=>import("./mtsfsh7z74bmo6ig.js").then(e=>e._),__vite__mapDeps([0,1])),{loading:e=>de(e)}),Jt=ae(()=>ne(()=>import("./f2itj05whsmn3kgs.js").then(e=>e._),__vite__mapDeps([2,1])),{loading:e=>de(e)}),Lt=ae(()=>ne(()=>import("./mbhfxri3syrb9rbq.js").then(e=>e._),__vite__mapDeps([3,1])),{loading:e=>de(e)});var Ue;const Ge=rt.div(Ue||(Ue=ke(["invisible absolute top-3 flex gap-1 group-hover/paragen-image:visible z-2\n  ","\n  ",""])),({$rightAlign:e})=>e?"end-3":"start-3",({$alwaysVisible:e})=>e?"visible":""),Qt=({imageUrl:e})=>{const[t,s]=i.useState(void 0),a=X(),r=Nt(),l=i.useCallback(()=>{const c=new Date,o=a.formatDate(c,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});return"".concat(o,".png")},[a]);return n.jsxs("div",{className:"group/paragen-image absolute inset-0 z-3",children:[n.jsxs(Ge,{$alwaysVisible:!0,children:[t!==!1&&n.jsx(ie,{icon:Kt,selected:t===!0,variant:"large",onClick:c=>{c.stopPropagation(),Y.paragenImageRated({liked:!0,analyticsContext:r}),s(!0)}}),t!==!0&&n.jsx(ie,{icon:Jt,selected:t===!1,variant:"large",onClick:c=>{c.stopPropagation(),Y.paragenImageRated({liked:!1,analyticsContext:r}),s(!1)}})]}),n.jsx(Ge,{$alwaysVisible:!0,$rightAlign:!0,children:n.jsx(ie,{icon:Lt,variant:"large",onClick:c=>{c.stopPropagation(),Y.paragenDownload({analyticsContext:r}),Et({url:e,fileName:l()})}})})]})};function Je({withLottie:e}){const s=X().formatMessage({id:"imagegen.progressIndicator.ariaLabel",defaultMessage:"Generating image..."});return n.jsx("div",{className:"absolute start-0 top-0 flex h-full w-full items-center justify-center rounded-full","aria-label":s,children:n.jsx(qe,{size:40,arcPercentage:.2,children:n.jsx(Ft,{animate:e,matchTextColor:!0,className:"h-6 w-6"})})})}const Le=300,Yt=1.3,Ae=.05,Xt=/blur\(([\d.]+)px\)/,Pt={duration:Le/1e3,ease:"linear"};function oe(e,t,s){var c,o,h,m,u;e.sort((g,d)=>g.lastSrcReceivedTime-d.lastSrcReceivedTime);const a=new Array(e.length).fill(0);for(let g=0;g<=e.length;g+=1){const d=g-1,S=g,_=(o=(c=e[d])==null?void 0:c.availablePercentComplete)!=null?o:0,y=(m=(h=e[S])==null?void 0:h.availablePercentComplete)!=null?m:1;if(t>=_&&t<=y&&_!==y){const f=(t-_)/(y-_);a[d]=1-f,a[S]=f}}const r=a[a.length-1],l=a[a.length-2];return r===1&&l===0&&(a[a.length-2]=.01),s&&t<=((u=e[0])==null?void 0:u.availablePercentComplete)&&(a[0]=1),a}const Zt=({alt:e,src:t,availablePercentComplete:s,onAnimationUpdate:a,ignoreFirstChunk:r=!1,isTransparent:l=!1,dimensions:c,onError:o,unconstrainedWidth:h=!1,progressLoaderProps:m})=>{const u=ct(),g=i.useMemo(()=>"url(".concat(u?Gt:At,")"),[u]),[d,S]=i.useState(!1),[_,y]=i.useState(1e3),[f,I]=i.useState(s!=null?s:0),[x,w]=i.useState(s===1?1:0),M=i.useRef(performance.now()),N=i.useRef(0),v=i.useRef([]),[z,C]=i.useState([0]),[H,U]=i.useState(s===1),F=i.useRef(!1),G=i.useRef(null),K=f===1,E=s===1&&H,O=c?c.width/c.height:1;i.useEffect(()=>{!d&&s&&(S(!0),N.current=performance.now())},[d,s]),i.useEffect(()=>{var R;const p=(R=v.current[v.current.length-1])==null?void 0:R.src;if(t&&t!==p){const A=v.current.findIndex(b=>b.availablePercentComplete===s);A!==-1?v.current[A]={src:t,availablePercentComplete:s!=null?s:0,lastSrcReceivedTime:performance.now()}:v.current.push({src:t,availablePercentComplete:s!=null?s:0,lastSrcReceivedTime:performance.now()}),C(oe(v.current,f,r))}},[t,f,r,s]);const J=i.useCallback(()=>{G.current&&s&&(y(E?Le:(performance.now()-M.current)*Yt),(!r||F.current||s>=Ae)&&s!==1&&w(s),F.current=!0,M.current=performance.now(),m==null||m.setHasImageReady(!0))},[s,E,r,m]),P=i.useCallback(p=>{const R=parseFloat(p.height)/100;a==null||a(R),I(R),C(oe(v.current,parseFloat(p.height)/100,r))},[a,r]),q=i.useCallback(p=>{var L,j;const R=(j=(L=p.filter.toString().match(Xt))==null?void 0:L[1])!=null?j:"0",b=(16-parseFloat(R))/16,V=1-x,$=x+V*b;a==null||a($),I($),C(oe(v.current,$,r))},[r,x,a]);if(!d)return n.jsx(We,{isDimensionsUnknown:!0,children:n.jsx(Je,{withLottie:!0})});const B={duration:_/1e3,ease:"linear"},ee=s!==1||!l;return n.jsxs("div",{className:W("relative z-0 cursor-pointer overflow-hidden",O<1?"max-w-[400px]":"max-w-[480px]",!K&&"pointer-events-none",!F.current&&"bg-token-main-surface-secondary",h&&"max-w-full"),"aria-label":e,style:{aspectRatio:O},children:[!(m!=null&&m.shouldHideDiagonalShimmer)&&s&&s<Ae&&n.jsx("div",{className:"absolute inset-0 z-3 w-full overflow-hidden",children:n.jsx("div",{className:"absolute start-[-150%] top-[-150%] h-[400%] w-[400%]",children:n.jsx("div",{className:"diagonal-sweep-gradient h-full w-full"})})}),n.jsxs(Q.div,{className:"absolute start-0 end-0 top-0 z-2 w-full overflow-hidden transition-[mask] ease-linear",initial:E?!1:{height:"0%"},animate:K?{height:"100%"}:{height:"".concat(x*100,"%")},onUpdate:E?void 0:P,transition:E?{duration:0,ease:"linear"}:B,style:K?void 0:{mask:"linear-gradient(rgb(0,0,0) 0%, rgb(0,0,0) calc(100% - 24px), rgba(0,0,0,0) 100%)"},children:[t&&n.jsx("img",{ref:G,src:t,onLoad:J,onError:o,alt:e,className:"absolute top-0 z-1 w-full",style:{aspectRatio:O}}),l&&n.jsx("div",{className:"absolute inset-0 z-0 w-full overflow-hidden opacity-0 transition-opacity duration-300 group-hover/imagegen-image:opacity-100 group-focus/imagegen-image:opacity-100",children:n.jsx("div",{className:"absolute inset-0 bg-repeat",style:{backgroundImage:g,backgroundSize:"auto"}})})]}),n.jsx(Q.div,{className:"relative z-1 w-full overflow-hidden",initial:{filter:"blur(16px)"},animate:E?{filter:"blur(0px)"}:void 0,transition:E?Pt:void 0,onUpdate:E?q:void 0,style:{aspectRatio:O},children:v.current.map((p,R)=>{const A=z[R],b=p.availablePercentComplete===1;return A!==0||b?n.jsx("img",{src:p.src,alt:e,style:{opacity:A,willChange:"opacity",aspectRatio:O},className:!E&&(m!=null&&m.shouldShowPulseAnimation)?"bg-scale-pulse":"",onLoad:b?()=>U(!0):void 0},p.src):null})}),n.jsx(Q.div,{className:"absolute inset-0 z-0 scale-110 overflow-hidden blur-2xl",style:{aspectRatio:O},children:ee&&v.current.filter((p,R)=>z[R]!==0).map(p=>n.jsx("img",{src:p.src,alt:e,className:"absolute top-0 w-full"},p.src))})]})},en=({imageAssetPointer:e,serverThreadId:t})=>{var m;const[s,a]=i.useState(void 0),r=ue(),l=Tt(r),c=(m=e.metadata)==null?void 0:m.watermarked_asset_pointer,o=i.useRef(!1),{isUnauthenticated:h}=ze();return i.useEffect(()=>{if(l&&c&&!o.current){o.current=!0;const u=lt(c);ut(u,void 0,h,t,!1).then(g=>{g.status===dt.Success&&a(g.download_url)}).catch(g=>{g instanceof mt||re.addError(new Error("Could not fetch watermarked image with ID ".concat(c," from file service"),{cause:g}))})}},[l,c,h,t]),s},Te=2,se=({pointer:e,altLabel:t,isEditorAvailable:s,onPercentageRendered:a,messageId:r,imageIndex:l,clientThreadId:c,serverThreadId:o,onEditorClick:h,compact:m,progressLoaderProps:u})=>{var p,R,A,b,V,$,L;const g=Oe(),[d,S]=i.useState(void 0),_=i.useRef(void 0),y=(R=(p=e.metadata)==null?void 0:p.generation)==null?void 0:R.gen_id,f=(V=(b=(A=e.metadata)==null?void 0:A.generation)==null?void 0:b.height)!=null?V:void 0,I=e.height,x=(f!=null?f:0)/I,w=i.useRef({}),[M]=Xe(),{isUnauthenticated:N}=ze(),[v,z]=i.useState(!1),C=i.useContext(He),H=e.width/e.height,U=en({imageAssetPointer:e,serverThreadId:o}),F=i.useCallback((j=!1)=>{!j&&_.current===e.asset_pointer||(_.current=e.asset_pointer,Ve.fetch(g,{asset:e,conversationId:o,force:j,isUnauthenticated:N}).then(T=>{S(T)}).finally(()=>{_.current=void 0}))},[e,g,o,N]);i.useEffect(()=>{const j=e.asset_pointer!==(d==null?void 0:d.asset_pointer);(!d||j)&&F()},[d,e.asset_pointer,F]);const G=i.useMemo(()=>$e({pointer:d,conversationId:o,messageId:r,source:C?"paragen":"chat",imageIndex:l.toString()}),[d,o,r,C,l]),K=i.useRef(x);i.useEffect(()=>{x===1&&K.current<1&&Y.renderingComplete({analyticsContext:G})},[x,G]);const E=i.useCallback(()=>{d&&(h==null||h({image:d,messageId:r,analyticsContext:G}))},[d,r,h,G]),O=i.useMemo(()=>({width:e.width,height:e.height}),[e]),J=i.useCallback(()=>{var T;const j=((T=w.current[e.asset_pointer])!=null?T:0)+1;if(w.current[e.asset_pointer]=j,w.current[e.asset_pointer]>Te)return re.addAction("image-gen-asset-error",{name:"retries-exhausted",conversation_id:o,asset_pointer:e.asset_pointer,max_retries:Te});re.addAction("image-gen-asset-retry",{name:"retry-attempted",conversation_id:o,asset_pointer:e.asset_pointer,current_retry:j}),w.current[e.asset_pointer]=j,F(!0)},[e.asset_pointer,F,o]),P=i.useCallback(j=>{j===1&&z(!0),a==null||a(j)},[a]),q=i.useRef(null),Z=i.useRef(null);i.useEffect(()=>{if(q.current&&(u!=null&&u.setContainerSize)){const j=q.current.getBoundingClientRect(),T={width:j.width,height:j.height},te=Z.current;(!te||te.width!==T.width||te.height!==T.height)&&(Z.current=T,u.setContainerSize(T))}},[u]);const B=d==null?void 0:d.url,ee=U!=null?U:B;return n.jsx(Dt.Provider,{value:G,children:n.jsxs("div",{ref:q,className:W("group/imagegen-image relative w-full overflow-hidden",H<1?"max-w-[400px]":"max-w-[480px]",m?"rounded-lg":"rounded-2xl",C&&"max-w-full",r===M.get("image")&&"[view-transition-name:var(--vt-active-image)]"),id:"image-".concat(r),style:{aspectRatio:H},onClick:s?E:void 0,tabIndex:0,children:[U&&n.jsx("img",{alt:t,className:"absolute inset-0 z-1 opacity-0",src:U}),n.jsx(Zt,{alt:t,src:B,availablePercentComplete:x,onAnimationUpdate:P,isEditorAvailable:s,ignoreFirstChunk:!0,isTransparent:(L=($=e.metadata)==null?void 0:$.generation)==null?void 0:L.transparent_background,dimensions:O,onError:J,unconstrainedWidth:C,progressLoaderProps:u},y),(u==null?void 0:u.state)&&(u==null?void 0:u.state)!==k.Complete&&!v&&(u==null?void 0:u.hasImageReady)&&n.jsx(Ke,{isGettingStarted:!1,messageId:r}),v&&!m&&(C?n.jsx(Qt,{imageUrl:B!=null?B:""}):n.jsx(Ut,{imageAssetPointer:B,imageUrl:ee,messageId:r,clientThreadId:c,serverThreadId:o,shouldShowOverflow:U!==void 0}))]},y)})},tn=({imageGenerationState:e,isInterrupted:t,asyncMessage:s,imageAssetPointer:a,altLabel:r,clientThreadId:l,serverThreadId:c,onEditorClick:o,isEditorAvailable:h,setAnimationPercentage:m,messageId:u})=>{var x;const[g,d]=i.useState(null),S=g==null,[_,y]=i.useState(!0),f=e===k.Thinking||e===k.AsyncGenerating&&!((x=s==null?void 0:s.metadata)!=null&&x.is_visually_hidden_from_conversation),I=e===k.Generating||e===k.Complete;return i.useEffect(()=>{f&&y(!1)},[f]),t?null:n.jsxs("div",{className:I?"relative pb-2":"relative",children:[(f||!_)&&n.jsx(Vt,{isDimensionsUnknown:S,width:g==null?void 0:g.width,height:g==null?void 0:g.height,children:S&&n.jsx(Ke,{isGettingStarted:!0,messageId:u})}),I&&n.jsx(Q.div,{className:_?"relative":"absolute inset-0 w-full",variants:{hidden:{opacity:0},visible:{opacity:1}},initial:"hidden",animate:_?"visible":"hidden",exit:"hidden",children:a&&n.jsx(se,{pointer:a,altLabel:r,isEditorAvailable:h,onPercentageRendered:m,messageId:u,clientThreadId:l,serverThreadId:c,imageIndex:0,onEditorClick:o,progressLoaderProps:{state:e,setContainerSize:d,hasImageReady:_,setHasImageReady:y,shouldHideDiagonalShimmer:!0,shouldShowPulseAnimation:!0}})})]})};function nn({title:e,description:t,shimmer:s}){return!e&&!t?null:n.jsxs("div",{className:"border-token-border-default my-2 max-w-[480px] min-w-72 rounded-2xl border p-6",children:[!!e&&n.jsx("p",{className:W("text-lg font-medium",s&&"loading-shimmer-pure-text-inverted",!!t&&"mb-1"),children:e}),!!t&&n.jsx("p",{children:t})]})}const an=e=>{"use forget";const t=Pe.c(7),{conversation:s,cotMessages:a,visualPercentComplete:r,isInterrupted:l,state:c}=e,o=l===void 0?!1:l,h=X();let m;t[0]!==h?(m=h.formatMessage({id:"imagegen.thinkingHeader.interrupted",defaultMessage:"Stopped creating image"}),t[0]=h,t[1]=m):m=t[1];const u=m,g=c===k.Complete||r===1;let d;e:{if(o){d=u;break e}else if(!a){d=void 0;break e}if(g){d=a.complete;break e}if(r){const y=Object.keys(a.generating);for(let f=0;f<y.length;f=f+1,f){const I=parseFloat(y[f]);if(r<I){d=a.generating[y[f]];break e}}}else{d=a.thinking;break e}d=a.complete}const S=d;let _;return t[2]!==s||t[3]!==S||t[4]!==o||t[5]!==g?(_=S&&n.jsx(Ht,{conversation:s,latestHeadline:S,isComplete:g||o,showChunkIcon:!1,isExpandDisabled:!0}),t[2]=s,t[3]=S,t[4]=o,t[5]=g,t[6]=_):_=t[6],_},sn=({pointersToRender:e,altLabel:t,isEditorAvailable:s,updatePercentageRendered:a,toolCallMessage:r,toolOutputMessageIds:l,clientThreadId:c,serverThreadId:o,handleEditorClick:h})=>{const m=le.useStore(),u=le.useSelectedIndex();i.useEffect(()=>{m.setSelectedIndex(Math.max(l.findIndex(x=>{var w;return x===((w=r==null?void 0:r.metadata)==null?void 0:w.selected_image_message_id)}),0))},[]);const g=i.useRef({}),d=i.useCallback(x=>w=>{g.current[x]=w;const M=Object.keys(g.current).length,N=Object.values(g.current).reduce((v,z)=>v+z,0);a==null||a(N/M)},[a]),[S,_]=i.useState(null),y=gt(c,ce.getRequestId),f=ft(y);i.useEffect(()=>{!f&&S!=null&&r!=null&&o!=null&&(De(r.id,l[S],c,o),_(null))},[f]);const I=i.useCallback(x=>{m.setSelectedIndex(x);const w=Object.values(g.current);ht.logEventWithStatsig("chatgpt_image_switched","chatgpt_image_switched",{conversationId:o,messageId:l[x],imageIndex:x.toString(),isLoading:(w.length===0||w.some(v=>v<1)).toString()});const M=ce.getConversationLastTurn(Fe(c)),N=(M==null?void 0:M.messages.find(v=>v.id===(r==null?void 0:r.id)))!=null;r!=null&&o!=null&&(N&&f?_(x):De(r.id,l[x],c,o))},[r,l,c,o,m,f,_]);return n.jsxs("div",{className:"flex gap-2",children:[n.jsx(se,{pointer:e[u],altLabel:t,isEditorAvailable:s,messageId:l[u],imageIndex:u,clientThreadId:c,serverThreadId:o,onEditorClick:h},l[u]),n.jsx("div",{className:"flex flex-col gap-2",children:e.map((x,w)=>{var M,N;return n.jsx(on,{pointer:x,altLabel:t,isSelected:w===u,onClick:()=>I(w),onPercentageRendered:(N=(M=x.metadata)==null?void 0:M.generation)!=null&&N.gen_id?d(x.metadata.generation.gen_id):void 0,messageId:l[w],imageIndex:w,clientThreadId:c,serverThreadId:o},l[w])})})]})},on=({pointer:e,altLabel:t,isSelected:s,onClick:a,onPercentageRendered:r,messageId:l,imageIndex:c,clientThreadId:o,serverThreadId:h})=>n.jsxs("button",{type:"button",onClick:a,className:"relative w-14 rounded-lg p-1",children:[n.jsx("div",{className:W(s&&"opacity-70"),children:n.jsx(se,{pointer:e,altLabel:t,isEditorAvailable:!1,onPercentageRendered:r,messageId:l,imageIndex:c,clientThreadId:o,serverThreadId:h,compact:!0})}),s&&n.jsx("div",{className:"border-token-border-default pointer-events-none absolute inset-0 rounded-xl border-2"})]});async function De(e,t,s,a){const r=await xt.safePost("/image-gen/message-select",{requestBody:{message_id:e,selected_image_message_id:t,conversation_id:a}}),l=r.id;l!=null&&It(s,c=>{_t.updateTree(c,o=>{o.updateNodeMessage(l,r)})})}function rn(e){const t=e.find(c=>c.author.role==="tool"&&c.author.name===Ot&&c.content.content_type==="text"),[s,...a]=(t==null?void 0:t.content.content_type)==="text"?t.content.parts:[],r=a.pop(),l=a.length;return s&&r&&a.length>0?{thinking:s,complete:r,generating:a.reduce((c,o,h)=>{const m=(h+1)/l;return c[m.toFixed(2)]=o,c},{})}:void 0}const cn=e=>{const t=X(),{size:s="image",count:a=1}=e||{};return a>1?{thinking:t.formatMessage({id:"cdnmKo",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"aTbInH",defaultMessage:"Creating images. May take a moment."}),"0.67":t.formatMessage({id:"WRM3Yw",defaultMessage:"Creating images. May take a moment."}),"1.00":t.formatMessage({id:"8ZydRG",defaultMessage:"Creating images. May take a moment."})},complete:t.formatMessage({id:"XQ81dl",defaultMessage:"Images created"})}:s==="xlimage"?{thinking:t.formatMessage({id:"y7op2E",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"cdrDJH",defaultMessage:"Creating image. May take a moment."}),"0.67":t.formatMessage({id:"RP4bRn",defaultMessage:"Adding details"}),"1.00":t.formatMessage({id:"o36MSQ",defaultMessage:"Finishing touches"})},complete:t.formatMessage({id:"QsnnBN",defaultMessage:"Image created"})}:{thinking:t.formatMessage({id:"6c7+kN",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"DP6/8y",defaultMessage:"Creating image"}),"0.67":t.formatMessage({id:"k9y1TT",defaultMessage:"Creating image"}),"1.00":t.formatMessage({id:"GpR7v3",defaultMessage:"Creating image"})},complete:t.formatMessage({id:"l2Izz4",defaultMessage:"Image created"})}},ln=ae(()=>ne(()=>import("./iuuhyyi1fiiwu4me.js"),__vite__mapDeps([4,1,5,6,7,8,9,10,11,12,13,14,15,16])).then(e=>e.ImageGenConversationLightboxNew)),un=[k.Empty,k.Errored],Sn=({messages:e,clientThreadId:t,isLastTurnInConversation:s,isParagen:a=!1})=>{var P,q,Z,B,ee,p,R,A;const r=ue(),l=wt(r,t),c=Ne(l.serverId$),o=X(),h=o.formatMessage({id:"imagegen.message.altLabel",defaultMessage:"Generated image"}),{messageIds:m,imageAssetPointers:u}=i.useMemo(()=>Ee(e),[e]),g=e.find(Bt),d=le.useSelectedIndex(),S=(Z=(q=(P=u==null?void 0:u[d])==null?void 0:P.metadata)==null?void 0:q.generation)==null?void 0:Z.gen_size,_=cn({size:S!=null?S:"image",count:(B=u==null?void 0:u.length)!=null?B:1}),y=i.useMemo(()=>{var b;return(b=rn(e))!=null?b:_},[e,_]),f=e.find(b=>{var V;return(V=b.metadata)==null?void 0:V.image_gen_async}),I=i.useMemo(()=>zt(e,s),[e,s]),x=vt(),w=St(),M=i.useRef(!1),N=i.useRef(!1),v=i.useRef(null),z=i.useMemo(()=>$e({pointer:u[d],conversationId:c,messageId:m[d],source:a?"paragen":"chat",imageIndex:d.toString()}),[u,m,d,c,a]);i.useEffect(()=>{if(!M.current&&(I===k.Thinking||I===k.Generating))M.current=!0,v.current=performance.now();else if(M.current&&!N.current)if(I===k.Complete){const b=v.current?performance.now()-v.current:void 0;Y.generationSuccess({analyticsContext:z,durationMs:b}),N.current=!0}else I===k.Errored&&(Y.generationFailure({analyticsContext:z,errorReason:"assistant_error"}),N.current=!0)},[I,z]);const C=e[e.length-1],H=i.useMemo(()=>C&&pt(C),[C]),U=Ne(()=>jt(l).id),F=Be(r,"3019066937").get("should_use_new_ui",!1),G=kt({clientThreadId:l.id})&&I===k.Complete,[K,E]=i.useState(0),O=Oe(),J=i.useCallback(async({image:b,analyticsContext:V})=>{var fe,he,xe;if(w)return x.warning(o.formatMessage({id:"imagegen.message.editorClick.integratedVoiceMode",defaultMessage:"Exit voice mode to view / edit the image"}));const $=Fe(l.id),L=$?ce.getConversationTurns($).flatMap(D=>D.messages):e,{imageAssetPointers:j,messageIds:T}=Ee(L,{skipSort:!0}),me=(a?[b]:await Promise.all(j.map(D=>Ve.fetch(O,{asset:D,conversationId:c})))).map((D,Ie)=>{var _e,we,ve,Se,pe,be;return{id:(ve=(we=(_e=D.metadata)==null?void 0:_e.generation)==null?void 0:we.gen_id)!=null?ve:T[Ie],archived:!1,transformationId:(be=(pe=(Se=D.metadata)==null?void 0:Se.generation)==null?void 0:pe.gen_id)!=null?be:null,url:D.url,assetPointer:D.asset_pointer,thumbnail:null,width:D.width,height:D.height,title:null,conversationId:c,messageId:T[Ie]}});Y.editorClick({sourceOperation:(xe=(he=(fe=b.metadata)==null?void 0:fe.dalle)==null?void 0:he.edit_op)!=null?xe:"none",analyticsContext:V});const ge=me.findIndex(D=>D.assetPointer===b.asset_pointer);bt(r,ln,{images:me,initialIndex:ge===-1?0:ge,conversation:l,currentModelId:U})},[w,l,e,a,r,x,o,O,c,U]);return un.includes(I)?null:n.jsx(He.Provider,{value:a,children:n.jsx("div",{className:"flex flex-col",children:F?n.jsx(tn,{imageGenerationState:I,isInterrupted:H,asyncMessage:f,imageAssetPointer:u[0],altLabel:h,clientThreadId:l.id,serverThreadId:c,onEditorClick:J,setAnimationPercentage:E,isEditorAvailable:G,messageId:m[0]}):n.jsxs(n.Fragment,{children:[I!==k.Unavailable&&I!==k.AsyncGenerating&&I!==k.AsyncHanging&&!((ee=C==null?void 0:C.metadata)!=null&&ee.async_completion_id)&&n.jsx("div",{className:"pb-3",children:n.jsx(an,{conversation:l,cotMessages:y,visualPercentComplete:K,isInterrupted:H,state:I})}),I===k.Thinking&&!H&&n.jsx(We,{isDimensionsUnknown:!0,children:n.jsx(Je,{withLottie:!0})}),I===k.AsyncGenerating&&!((p=f==null?void 0:f.metadata)!=null&&p.is_visually_hidden_from_conversation)&&n.jsx(nn,{shimmer:!0,title:(R=f==null?void 0:f.metadata)==null?void 0:R.ui_card_title,description:(A=f==null?void 0:f.metadata)==null?void 0:A.ui_card_description}),(I===k.Generating||I===k.Complete)&&!H&&n.jsx("div",{className:"pb-2",children:u.length>1?n.jsx(sn,{pointersToRender:u,altLabel:h,isEditorAvailable:G,updatePercentageRendered:E,toolCallMessage:g,toolOutputMessageIds:m,clientThreadId:l.id,serverThreadId:c,handleEditorClick:J}):n.jsx(se,{pointer:u[0],altLabel:h,isEditorAvailable:G,onPercentageRendered:E,messageId:m[0],imageIndex:0,clientThreadId:l.id,serverThreadId:c,onEditorClick:J})})]})})})};export{Sn as ImageGenMessage};
//# sourceMappingURL=w7v4xtpg6tjbasgx.js.map
