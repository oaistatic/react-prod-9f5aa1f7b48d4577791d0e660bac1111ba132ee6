const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ceivmd4pm4umbvdn.js","assets/i8clt0mfz495j7ii.js","assets/brx1ehse1il2u1b0.js","assets/cr5h05bhk5js9k9c.js","assets/mbhfxri3syrb9rbq.js","assets/ghewn7l2ynbm32fm.js","assets/root-c4psboex.css","assets/nju52ppu7cxhyzrm.js","assets/nt70i7v0q9til63b.js","assets/j0yo6uv6652vva62.js","assets/conversation-small-lq38g8zw.css","assets/gk19dtvu6bikdyrw.js","assets/zm1ki9l766pgg0bx.js","assets/m360psfv67etw60z.js","assets/lkw8iwfdfi4ojt36.js","assets/hvzeon76b5ffe4h0.js","assets/ot1i36fs7pr1r2qj.js","assets/dpcr594ttxe7tgct.js","assets/hkwy60i7c1zytn8i.js","assets/da0eqg5j39u1e96s.js","assets/ksuwacyo5m7qmkk7.js","assets/fy1n36to2eb0czaf.js","assets/nvrhbbc4qxooogd5.js","assets/l3jkxavl2du23cqn.js","assets/pcwyhd2ia1xnez4s.js"])))=>i.map(i=>d[i]);
var ua=Object.freeze,ga=Object.defineProperty,Ao=Object.defineProperties;var Fo=Object.getOwnPropertyDescriptors;var as=Object.getOwnPropertySymbols;var ha=Object.prototype.hasOwnProperty,pa=Object.prototype.propertyIsEnumerable;var ma=(s,n,o)=>n in s?ga(s,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):s[n]=o,$=(s,n)=>{for(var o in n||(n={}))ha.call(n,o)&&ma(s,o,n[o]);if(as)for(var o of as(n))pa.call(n,o)&&ma(s,o,n[o]);return s},oe=(s,n)=>Ao(s,Fo(n));var fa=(s,n)=>{var o={};for(var t in s)ha.call(s,t)&&n.indexOf(t)<0&&(o[t]=s[t]);if(s!=null&&as)for(var t of as(s))n.indexOf(t)<0&&pa.call(s,t)&&(o[t]=s[t]);return o};var js=(s,n)=>ua(ga(s,"raw",{value:ua(n||s.slice())}));import{_ as Y,e as ds,h as Ds,r,d as No,j as e,M as me,f as Do,R as Za,m as Oo}from"./i8clt0mfz495j7ii.js";import{dO as Lo,dS as Ho,d7 as Vo,d6 as ve,dP as Uo,dQ as Bo,iL as Go,dp as Wo,aW as qo,aX as $o,aY as zo,d5 as Ko,h8 as Qo,jI as Xo,kU as Jo,kV as Yo,iJ as Zo,kW as ei,hI as xa,bg as si,kX as _a,kY as ti,kZ as va,k_ as ai,k$ as en,cm as ni,cn as oi,co as ii,l0 as ri,aS as li,aT as di,ii as ci,l1 as ui,l2 as mi,cr as gi,l3 as hi,cv as sn,l4 as pi,g_ as fi,l5 as ba,aa as xi,l6 as _i,cQ as As,l7 as vi,fJ as bi,l8 as Ii,z as Si,l9 as Ci,ka as Ti,la as yi,lb as Mi,lc as wi,ld as Ia,le as ji,ac as Sa,lf as Ei,lg as Pi,lh as ki,li as Ri,lj as Ai,lk as Fi,bX as Ni,ll as Di,lm as Oi,ln as Li,lo as Hi,lp as Vi,lq as Ui,lr as Bi,az as tn,ay as Fs,ls as Gi,lt as Wi,lu as qi,lv as $i,lw as Ca,lx as zi,ly as Ki,lz as Qi,lA as Xi,lB as Ta,lC as Ji,lD as Yi,lE as Zi,lF as er,lG as sr,lH as tr,lI as ar,e9 as nr,lJ as or,lK as ir,lL as rr,lM as lr,he as an,lN as dr,cS as cr,lO as ur,lP as mr,lQ as gr,lR as hr,lS as pr,lT as fr,lU as xr,lV as _r,h0 as vr,lW as br,lX as Ir,lY as Sr,lZ as Cr,l_ as Tr,l$ as yr,m0 as Mr,m1 as ya,m2 as wr,m3 as jr}from"./j0yo6uv6652vva62.js";import{o as Z,L as xe,e as Os,R as Ls,M as Es,hH as nn,eo as Er,e4 as Pr,u as We,ne as Ma,bN as kr,jv as wa,dw as ja,iu as Rr,a as te,iw as Ar,iv as Ea,ix as Fr,kT as Nr,b1 as on,cn as is,J as rs,aV as Dr,dM as Hs,F as rn,bQ as ls,cE as A,cI as ln,bO as B,co as z,d as pe,pG as dn,ba as Or,mh as Lr,cH as be,bT as Ie,bY as Vs,bR as Ge,iG as Hr,cg as cn,$ as un,hy as mn,A as Vr,dd as Pa,a5 as Ur,iA as Br,aN as Gr,i as Wr,et as qr,f as $r,W as zr,ht as Ps,hv as Kr,eR as Qr,bW as Xr,h as Ne,ak as Ue,bx as Jr,eg as Yr,jC as Zr,cK as el,c4 as sl,mi as tl,mg as al,a0 as nl,P as De,cS as Be,o1 as ol,ff as il,bM as ns,pH as rl,bh as gn,jT as ll,bX as ks,pI as ka,pJ as dl,cl as Ra,pK as cl,dA as ul,dB as ml,aO as gl,a4 as Aa,jc as os,cm as Fa,dp as hl,j4 as pl,aW as fl,lZ as xl,aX as Us,em as Na,pL as _l,lP as vl,el as bl,f5 as Il,hw as Sl,dj as Cl,lk as Da,cO as Tl}from"./ghewn7l2ynbm32fm.js";import{C as Ns}from"./hlon4mihnqp86jji.js";import{T as yl,U as Ml,A as wl}from"./f6ek1vdaohim72xh.js";import{I as jl}from"./mh1u90j45tiq86ol.js";import{P as El,a as Pl}from"./mpzbsmypy64alaao.js";const kl=Z(()=>Y(()=>import("./ceivmd4pm4umbvdn.js").then(s=>s._),__vite__mapDeps([0,1])),{loading:s=>xe(s)}),Rl=Z(()=>Y(()=>import("./brx1ehse1il2u1b0.js").then(s=>s._),__vite__mapDeps([2,1])),{loading:s=>xe(s)}),Al=Z(()=>Y(()=>import("./cr5h05bhk5js9k9c.js").then(s=>s._),__vite__mapDeps([3,1])),{loading:s=>xe(s)}),Fl=Z(()=>Y(()=>import("./mbhfxri3syrb9rbq.js").then(s=>s._),__vite__mapDeps([4,1])),{loading:s=>xe(s)}),Nl=Z(()=>Y(()=>import("./ghewn7l2ynbm32fm.js").then(s=>s.vJ),__vite__mapDeps([5,1,6])),{loading:s=>xe(s)}),Dl=({image:s,onClose:n,onRequestCompletion:o,clientThreadId:t,currentModelId:i,post:m,canDelete:u,onOpenReport:p})=>{var h;const c=ds(),w=Os(),y=Ds(),[g,L]=r.useState("default"),v=Lo(),P=r.useRef(null),b=r.useRef(v);r.useEffect(()=>{b.current=v},[v]);const C=r.useCallback(()=>Ho(c),[c]),G=r.useCallback(()=>{s&&L("inpaint")},[s]),j=r.useCallback(()=>{L("default"),b.current.clearAllDrawings()},[]),K=r.useCallback(()=>{s&&Vo({url:s.url,fileName:C()})},[s,C]),V=r.useCallback(()=>{var M;return(M=P.current)==null?void 0:M.getImageData()},[]),F=r.useCallback(async()=>{if(window.confirm(c.formatMessage({id:"postReceiverModal.deletePostConfirmation",defaultMessage:"Are you sure you want to delete this post?"})))try{await Ls.safeDelete("/share/post/{post_id}",{parameters:{path:{post_id:m.id}}}),y("/",{replace:!0})}catch(M){w.danger(No({id:"postReceiverModal.deletePostError",defaultMessage:"Failed to delete the post"}),{toastId:"post_receiver_modal.delete_post_error"})}},[m.id,c,w,y]),D=g==="inpaint"?c.formatMessage({id:"TjVqYb",defaultMessage:"Edit Selection"}):(h=m.text)!=null?h:c.formatMessage({id:"htGxHc",defaultMessage:"Image"}),E=r.useCallback(M=>{M.key==="Escape"&&(n(),M.preventDefault())},[n]);return r.useEffect(()=>(document.addEventListener("keydown",E),()=>document.removeEventListener("keydown",E)),[E]),e.jsx(Es.Root,{isOpen:!0,onClose:n,testId:"modal-lightbox-post-share",shouldIgnoreClickOutside:g==="inpaint",children:e.jsx(Es.Overlay,{children:e.jsxs(Es.Content,{size:"fullscreen",removePopoverStyling:!0,className:"grid min-h-0 grid-rows-[auto_minmax(0,1fr)] overflow-hidden",children:[e.jsxs("header",{className:"flex h-14 w-full items-center justify-between gap-2 px-2 md:px-4",children:[e.jsxs("div",{className:"flex min-w-0 items-center gap-2",children:[e.jsx(ve,{icon:Nl,onClick:n,"aria-label":c.formatMessage({id:"EYLKSm",defaultMessage:"Close"})}),e.jsx("h2",{className:"line-clamp-1 text-base font-medium",children:D})]}),e.jsx("div",{className:"flex items-center gap-2",children:g==="inpaint"?e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"aspect-square",icon:Uo,onClick:v.undoDrawing,disabled:!v.canUndoDrawing,"aria-label":c.formatMessage({id:"OmaTPx",defaultMessage:"Undo"})}),e.jsx(ve,{className:"aspect-square",icon:Bo,onClick:v.redoDrawing,disabled:!v.canRedoDrawing,"aria-label":c.formatMessage({id:"ZUr4oh",defaultMessage:"Redo"})}),e.jsx(ve,{className:"w-auto px-3",onClick:j,children:c.formatMessage({id:"D9xvar",defaultMessage:"Cancel"})})]}):e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"aspect-square",icon:Rl,onClick:G,"aria-label":c.formatMessage({id:"pRGwlp",defaultMessage:"Edit image"})}),e.jsx(ve,{className:"aspect-square",icon:Fl,onClick:K,"aria-label":c.formatMessage({id:"9DNHka",defaultMessage:"Download image"})}),e.jsx(ve,{className:"aspect-square",icon:Al,onClick:p,"aria-label":c.formatMessage({id:"2gNXdX",defaultMessage:"Report content"})}),u&&e.jsx(ve,{className:"aspect-square",icon:kl,onClick:F,"aria-label":c.formatMessage({id:"rzlDpj",defaultMessage:"Delete post"})})]})})]}),e.jsxs("div",{className:"grid h-full w-full grid-rows-[1fr_auto] items-center overflow-y-auto overscroll-contain",children:[e.jsx("div",{className:"flex h-full w-full items-center justify-center px-4 pb-4",children:s&&e.jsxs("div",{className:"relative inline-block max-h-full rounded bg-neutral-100",children:[e.jsx("img",{src:s.url,alt:D,className:"h-full max-h-[70vh] w-auto max-w-full rounded object-contain",fetchPriority:"high"}),g==="inpaint"&&e.jsx(Go,{image:s,drawingState:v,drawingCanvasRef:P})]})}),e.jsx("div",{className:"flex w-full justify-center px-4 pb-8",children:e.jsx("div",{className:"w-full max-w-[768px]",children:e.jsx(jl,{clientThreadId:t,currentModelId:i,onRequestCompletion:o,onClose:n,activeImage:s,currentDrawnShape:v.currentDrawnShape,getImageData:V,onCancelInpaint:j})})})]})]})})})},Ol=Z(()=>Y(()=>import("./ceivmd4pm4umbvdn.js").then(s=>s._),__vite__mapDeps([0,1])),{loading:s=>xe(s)}),Ll=Z(()=>Y(()=>import("./cr5h05bhk5js9k9c.js").then(s=>s._),__vite__mapDeps([3,1])),{loading:s=>xe(s)}),Hl=Z(()=>Y(()=>import("./nju52ppu7cxhyzrm.js").then(s=>s._),__vite__mapDeps([7,1])),{loading:s=>xe(s)});function gd({postWithProfile:s,clientThreadId:n,onClose:o}){var t,i;return((t=s.post.attachments[0])==null?void 0:t.kind)==="media_generation"?e.jsx(Vl,{postWithProfile:s,clientThreadId:n,onClose:o}):((i=s.post.attachments[0])==null?void 0:i.kind)==="message_slice"?e.jsx(Ul,{postWithProfile:s,onClose:o}):null}function Vl({postWithProfile:s,clientThreadId:n,onClose:o}){var h;const t=We(),i=kr(t,n),m=r.useRef(null),[u,p]=r.useState(!1),c=Ds(),{post:w}=s,y=w.attachments[w.attachments.length-1],g={url:y.url,content_type:ja.ImageAssetPointer,asset_pointer:(h=y.asset_pointer)!=null?h:wa(y.id),width:y.width,height:y.height},L=ds(),v=Rr(),P=te(i.serverId$),b=Os(),C=r.useCallback(M=>v.getState().files.find(T=>T.tempId===M),[v]),G=y.url,j=r.useCallback(async M=>{if(m.current){const T=await m.current,f=T?C(T==null?void 0:T.tempId):null;if(f)return f}return m.current=fetch(M).then(T=>T.blob()).then(T=>{const f=new File([T],"image.png",{type:"image/png"}),O=Ar(f);return Ea.uploadFile(v,O,f,Fr.Multimodal,[f.type],L,b).then(()=>{const k=C(O);return k&&k.status===Nr.Ready&&k.fileId?k:null})}),m.current},[v,L,b,C]),K=te(()=>Hs(i).id),{isUnauthenticated:V}=on(),F=r.useCallback(async M=>{var T;if(!(!M.promptMessage||V))try{const f=await j(G);if(!f||!f.fileId||!f.fileSpec)return;const O=[{content_type:ja.ImageAssetPointer,asset_pointer:wa(f.fileId),size_bytes:f.fileSpec.size,width:y.width,height:y.height},...M.promptMessage.content.content_type===is.MultimodalText||M.promptMessage.content.content_type===is.Text?M.promptMessage.content.parts:[]];Ko(oe($({conversation:i},M),{promptMessage:oe($({},M.promptMessage),{content:{content_type:is.MultimodalText,parts:O}}),extraStreamParams:oe($({},(T=M.extraStreamParams)!=null?T:{}),{continueFromSharedPostId:w.id})})),Ea.reset(v)}catch(f){rs.addError(new Error("post_receiver_handle_request_failed",{cause:f})),b.danger({id:"postReceiverModal.editImageError",defaultMessage:"Failed to edit the image",description:"Error message for editing an image"},{toastId:"post_receiver_modal.edit_image_error"})}},[i,y.height,y.width,j,v,G,V,b,w.id]),D={id:w.id,archived:!1,transformationId:null,url:g.url,assetPointer:g.asset_pointer,thumbnail:null,width:g.width,height:g.height,title:null,conversationId:P,messageId:w.id},E=r.useCallback(()=>{o(),c("/",{replace:!0})},[o,c]);return e.jsxs(e.Fragment,{children:[e.jsx(Dl,{image:D,onClose:E,onRequestCompletion:F,clientThreadId:i.id,currentModelId:K,post:w,canDelete:!!w.permissions.can_delete,onOpenReport:()=>p(!0)}),u&&e.jsx(hn,{post:w,onClose:()=>p(!1)})]})}function Ul({postWithProfile:s,onClose:n}){const[o,t]=r.useState(!1),{post:i}=s;return e.jsxs("div",{className:"bg-token-bg-primary absolute start-0 end-0 top-0 bottom-0 h-full w-full",children:[e.jsx(Bl,{post:i,setIsReportModalOpen:t,onClose:n}),e.jsx(Qo,{attachments:i.attachments,variant:"fullscreen"}),o&&e.jsx(hn,{post:i,onClose:()=>t(!1)})]})}function Bl({post:s,setIsReportModalOpen:n,onClose:o,additionalButtons:t}){const i=Ds(),m=ds(),u=Os(),p=r.useCallback(async()=>{if(window.confirm(m.formatMessage({id:"postReceiverModal.deletePostConfirmation",defaultMessage:"Are you sure you want to delete this post?"})))try{await Ls.safeDelete("/share/post/{post_id}",{parameters:{path:{post_id:s.id}}}),i("/",{replace:!0})}catch(c){u.danger({id:"postReceiverModal.deletePostError",defaultMessage:"Failed to delete the post",description:"Error message for deleting a post"},{toastId:"post_receiver_modal.delete_post_error"})}},[s.id,m,u,i]);return e.jsx(e.Fragment,{children:e.jsxs(Dr.div,oe($({className:"flex h-16 w-full px-2 sm:px-4"},Xo),{children:[e.jsx("div",{className:"flex items-center justify-self-start text-start",children:e.jsx(Jo,{onClose:()=>{o(),i("/",{replace:!0})}})}),e.jsx("div",{className:"flex w-full flex-1 flex-col items-center justify-center justify-self-stretch",children:e.jsx(Yo,{areButtonsFullWidth:!0,post:s,setIsReportModalOpen:n})}),e.jsxs("div",{className:"flex items-center justify-self-end text-end",children:[s.permissions.can_delete&&e.jsx(Zo,{tooltip:m.formatMessage({id:"postReceiverModal.deletePost",defaultMessage:"Delete"}),onClick:p,children:e.jsx(Ol,{})}),t]})]}))})}function hn({post:s,onClose:n}){var p;const o=We(),{data:t}=qo(o,Ma.Post),i=ds(),m=$o(o,i,s.id,Ma.Post);if(t==null)return null;const u="Report ".concat((p=s.text)!=null?p:"Post");return e.jsx(zo,{reasons:t.reasons,submitReport:m,title:u,onClose:n,header:t.header,subHeader:t.header_explanation})}function Gl(){var t;const s=r.useContext(nn),n=(t=s==null?void 0:s.postWithProfile)==null?void 0:t.post,o=s==null?void 0:s.setIsReportModalOpen;return!n||!o?null:e.jsxs("div",{className:"outline-token-border-default mx-4 flex items-center justify-between gap-2.5 rounded-2xl py-1 ps-4 pe-0.5 outline-1 outline-offset-[-1px]",children:[e.jsx("span",{className:"text-token-text-secondary justify-center text-sm leading-tight",children:e.jsx(me,{id:"e2L5bY",defaultMessage:"Content created using ChatGPT"})}),e.jsx(Er,{size:"default",contentAlign:"end",sideOffset:4,triggerButton:e.jsx(Wo,{className:"rounded-full",label:"",icon:e.jsx(Hl,{className:"icon-sm"})}),children:e.jsx(Pr.Item,{icon:Ll,onClick:()=>o(!0),children:e.jsx(me,{id:"jHHbcM",defaultMessage:"Flag content as unsafe"})})})]})}function hd(){var t;const s=r.useContext(nn),n=(t=s==null?void 0:s.postWithProfile)==null?void 0:t.post,o=s==null?void 0:s.setIsReportModalOpen;return!n||!o?null:e.jsx("div",{className:"text-token-text-secondary text-sm",children:e.jsx(me,{id:"iRpGVT",defaultMessage:"Content created using ChatGPT. <reportButton>Report</reportButton> if unsafe.",values:{reportButton:i=>e.jsx("button",{className:"text-token-text-primary decoration-token-text-primary underline",onClick:()=>{o(!0)},children:i})}})})}const Oa=Z(()=>Y(()=>import("./nt70i7v0q9til63b.js"),__vite__mapDeps([8,1,5,6,9,10,11,12])).then(s=>s.MemoryActionResult));function La(s,n,o){Ie(s,t=>{Vs.updateTree(t,i=>{i.updateNodeMetadata(n,{inlineComparisonRating:o})})})}const Ha=({messages:s})=>{for(const{metadata:n}of s){const{paragen_display_label:o}=n!=null?n:{};if(o)return o;const{augmented_paragen_prompt_label:t}=n!=null?n:{};if(t)return t}};function Va({displayedMessages:s,message:n,conversationTurnMountTime:o,visibilityState:t}){var u,p;const i={},m=((u=n.clientMetadata)==null?void 0:u.variantsInStreamInfo)==null&&((p=n.metadata)==null?void 0:p.paragen_variants_info)!=null;return s.forEach((c,w)=>{const y=m?{load_first_token_time:o,load_end_time:o}:{load_first_token_time:c.loadFirstTokenTime,load_end_time:c.loadEndTime},g=w===0?{rendered_height:t.left_rendered_height}:{rendered_height:t.right_rendered_height};i[c.messageId]=$($({},y),g)}),i}function Wl(s){const n=r.useRef({left_visibility_initial:null,left_visibility_max:null,right_visibility_initial:null,right_visibility_max:null,left_rendered_height:null,right_rendered_height:null}),o=r.useRef({left:null,right:null});return s.variantIds.length<2?e.jsx(pn,$({setPreferredFeedback:()=>{},leftVariantId:"left-placeholder",rightVariantId:"right-placeholder",leftTurn:null,rightTurn:null,originalTurn:null,hasActiveRequest:!0,visibilityStateRef:n,firstVisibleTokenTimestampsRef:o},s)):e.jsx(ql,oe($({},s),{visibilityStateRef:n,firstVisibleTokenTimestampsRef:o}))}function ql(s){const{conversation:n,variantIds:o,turnIndex:t,firstVisibleTokenTimestampsRef:i}=s;if(o.length!==2)throw new Error("ConversationTurnSideBySideFeedback requires exactly two variant IDs");const m=dn(),u=Or(),[p,c]=o,w=r.useMemo(()=>Lr(p+c)()>=.5,[p,c]),[y,g]=w?[c,p]:[p,c],[L,v,P]=be(n.id,V=>{var f,O,k,W,l,Q,N,ge,R,ee,ie,Se,Ce,x,X,se,I,re,le,J;const F=Pa(V).tree.getLeafFromNode(y).id,D=Pa(V).tree.getLeafFromNode(g).id,E=B.getConversationTurns(V,F),h=B.getConversationTurns(V,D),M=t<E.length?E[t]:null,T=t<h.length?h[t]:null;return M||rs.addError("Paragen Left turn index ".concat(t," out of bounds"),{turnIndex:t,turnCount:E.length,lastTurnRole:(f=A(E))==null?void 0:f.role,lastMessageAuthor:(k=A((O=A(E))==null?void 0:O.messages))==null?void 0:k.author,lastMessageContentType:(l=A((W=A(E))==null?void 0:W.messages))==null?void 0:l.content.content_type,lastMessageMetadata:(N=A((Q=A(E))==null?void 0:Q.messages))==null?void 0:N.metadata,altTurnCount:h.length,altLastTurnRole:(ge=A(h))==null?void 0:ge.role,altLastMessageRole:(ee=A((R=A(h))==null?void 0:R.messages))==null?void 0:ee.author.role}),T||rs.addError("Paragen Right turn index ".concat(t," out of bounds"),{turnIndex:t,turnCount:h.length,lastTurnRole:(ie=A(h))==null?void 0:ie.role,lastMessageAuthor:(Ce=A((Se=A(h))==null?void 0:Se.messages))==null?void 0:Ce.author,lastMessageContentType:(X=A((x=A(h))==null?void 0:x.messages))==null?void 0:X.content.content_type,lastMessageMetadata:(I=A((se=A(h))==null?void 0:se.messages))==null?void 0:I.metadata,altTurnCount:E.length,altLastTurnRole:(re=A(E))==null?void 0:re.role,altLastMessageRole:(J=A((le=A(E))==null?void 0:le.messages))==null?void 0:J.author.role}),[F,M,T]}),[b,C]=w?[P,v]:[v,P],G="skippable_parallel_2_in_stream:a:1.5";r.useEffect(()=>(va.setState({displayingSideBySideFeedback:!0}),()=>{va.setState({displayingSideBySideFeedback:!1})}),[]);const j=r.useRef({left_visibility_initial:null,left_visibility_max:null,right_visibility_initial:null,right_visibility_max:null,left_rendered_height:null,right_rendered_height:null}),K=r.useCallback((V,{shouldSubmitParagenFeedback:F=!0}={})=>{if(!v||!P||!b||!C)throw new Error("Expected both turns to exist");Ie(n.id,k=>{Vs.setCurrentBranch(k,V)});const D=V===y,E=V===p;b.messages.length>0&&La(n.id,b.messages[b.messages.length-1].id,E?"original":"new"),C.messages.length>0&&La(n.id,C.messages[C.messages.length-1].id,E?"original":"new");const h=Ge(n.id),M=[v,P].map((k,W)=>{var l,Q,N;return{messageId:k.messages[k.messages.length-1].id,loadFirstTokenTime:W===0?i.current.left:i.current.right,loadEndTime:(N=(Q=(l=A(k.messages))==null?void 0:l.clientMetadata)==null?void 0:Q.completionSampleFinishTime)!=null?N:null}}),T=D?M[0].messageId:M[1].messageId,f=B.getParentPromptNode(ls(n.id),L);if(!f)throw new Error("Expected prompt for side by side feedback");const O=Va({displayedMessages:M,message:f.message,conversationTurnMountTime:s.conversationTurnMountTime,visibilityState:j.current});F&&qa({params:{conversation_id:h,displayed_message_ids:M.map(k=>k.messageId),message_metadatas:O,rating:"selected",selected_message_id:T,source_timestamp:Date.now(),ui_variant:1,user_prompt_message_id:f.message.id}})},[n.id,y,p,b,C,v,P,L,i,s.conversationTurnMountTime,j]);return r.useEffect(()=>Hr(cn,{requestCompletion:V=>{const F=Ge(n.id),D=B.getParentPromptNode(ls(n.id),L);if(!D)throw new Error("Expected prompt for side by side feedback");if(!v||!P)throw new Error("Expected both turns to exist");const E=[v,P].map((T,f)=>{var O,k,W;return{messageId:T.messages[T.messages.length-1].id,loadFirstTokenTime:f===0?i.current.left:i.current.right,loadEndTime:(W=(k=(O=A(T.messages))==null?void 0:O.clientMetadata)==null?void 0:k.completionSampleFinishTime)!=null?W:null}}),h=Va({displayedMessages:E,message:D.message,conversationTurnMountTime:s.conversationTurnMountTime,visibilityState:j.current}),M=V.isForSkippingParagen;qa({params:{conversation_id:F,displayed_message_ids:E.map(T=>T.messageId),message_metadatas:h,rating:M?"explicit_skipped":"skipped",selected_message_id:null,source_timestamp:Date.now(),ui_variant:M?3:1,user_prompt_message_id:D.message.id}}),M&&K(y,{shouldSubmitParagenFeedback:!1})}}),[v,P,L,n.id,s.conversationTurnMountTime,G,b==null?void 0:b.messages,C==null?void 0:C.messages,u,i,K,y,j]),e.jsx(pn,oe($({},s),{setPreferredFeedback:K,leftVariantId:y,rightVariantId:g,leftTurn:v,rightTurn:P,hasActiveRequest:m,originalTurn:b,visibilityStateRef:j}))}function pn(w){var y=w,{setPreferredFeedback:s,leftVariantId:n,rightVariantId:o,leftTurn:t,rightTurn:i,hasActiveRequest:m,originalTurn:u,visibilityStateRef:p}=y,c=fa(y,["setPreferredFeedback","leftVariantId","rightVariantId","leftTurn","rightTurn","hasActiveRequest","originalTurn","visibilityStateRef"]);var ie,Se,Ce;const g=(ie=t&&Ha(t))!=null?ie:null,L=(Se=i&&Ha(i))!=null?Se:null,v=r.useMemo(()=>{var x;return(x=t==null?void 0:t.messages)!=null?x:[]},[t==null?void 0:t.messages]),P=r.useMemo(()=>{var x;return(x=i==null?void 0:i.messages)!=null?x:[]},[i==null?void 0:i.messages]),{avatarClassName:b,firstVisibleTokenTimestampsRef:C}=c,G=r.useMemo(()=>{var x;return(x=t==null?void 0:t.messageGroups)!=null?x:[]},[t==null?void 0:t.messageGroups]),j=r.useMemo(()=>{var x;return(x=i==null?void 0:i.messageGroups)!=null?x:[]},[i==null?void 0:i.messageGroups]),K=ei(),V=ls(c.conversation.id),F=A(t==null?void 0:t.messages),D=A(i==null?void 0:i.messages),E=ln(B.getRequestId(V,(Ce=F==null?void 0:F.id)!=null?Ce:D==null?void 0:D.id)),h=E&&!(F!=null&&F.end_turn),M=E&&!(D!=null&&D.end_turn),T=F!=null&&xa(F),f=D!=null&&xa(D),O=T!=null?T:f,k=(t==null?void 0:t.role)===z.User,W=(i==null?void 0:i.role)===z.User,l=r.useRef(null),Q=r.useRef(null),N=r.useRef(null),ge=t!=null,R=i!=null;!ge&&C.current.left==null&&(C.current.left=Date.now()),!R&&C.current.right==null&&(C.current.right=Date.now()),r.useEffect(()=>{if(l.current&&Q.current&&N.current){const x=Array(11).fill(0).map((se,I)=>I/10),X=new IntersectionObserver(se=>se.forEach(I=>{var re,le,J,qe,Pe,$e;I.target===Q.current?((le=(re=p.current).left_visibility_initial)!=null||(re.left_visibility_initial=I.intersectionRatio),p.current.left_visibility_max=Math.max((J=p.current.left_visibility_max)!=null?J:0,I.intersectionRatio)):I.target===N.current&&((Pe=(qe=p.current).right_visibility_initial)!=null||(qe.right_visibility_initial=I.intersectionRatio),p.current.right_visibility_max=Math.max(($e=p.current.right_visibility_max)!=null?$e:0,I.intersectionRatio))}),{root:l.current,threshold:x});return X.observe(Q.current),X.observe(N.current),()=>X.disconnect()}},[p]),r.useEffect(()=>{const x=Q.current,X=N.current;if(!x||!X)return;let se=null;const I=()=>{se!=null&&cancelAnimationFrame(se),se=requestAnimationFrame(()=>{if(x.isConnected){const le=Math.round(x.getBoundingClientRect().height);p.current.left_rendered_height=le}if(X.isConnected){const le=Math.round(X.getBoundingClientRect().height);p.current.right_rendered_height=le}})},re=new ResizeObserver(I);return re.observe(x),re.observe(X),I(),()=>{se!=null&&cancelAnimationFrame(se),re.disconnect()}},[p]);const{data:ee}=si(void 0,!1,K);return e.jsxs("div",{className:"relative flex flex-col",children:[e.jsx("div",{className:"bg-token-main-surface-primary sticky top-[-1px] z-1 px-(--thread-content-margin) text-center text-lg text-pretty md:static","data-testid":"paragen-feedback-title",children:e.jsx(me,{id:"KKeSJV",defaultMessage:"You're giving feedback on a new version of ChatGPT."})}),e.jsx("div",{className:"text-token-text-secondary px-(--thread-content-margin) pt-1 pb-5 text-center text-sm text-pretty",children:e.jsx(me,{id:"TK934w",defaultMessage:"Which response do you prefer? Responses may take a moment to load."})}),e.jsx("div",{className:pe(ti("default"),"horzScrollShadows relative -mb-2 snap-x snap-mandatory overflow-x-auto overflow-y-clip pb-4"),ref:l,children:e.jsxs("div",{className:pe("mx-auto box-content max-w-[calc(2*var(--thread-content-max-width))] min-w-min px-(--thread-content-margin)","flex items-start gap-4 sm:gap-6"),children:[e.jsxs(Ua,{rootElementRef:Q,onClick:()=>{s(n)},hasActiveRequest:m,isImageGenInProgress:O,children:[e.jsxs(Ga,{children:[e.jsx(_a,{messages:v,isUserTurn:k,avatarClassName:b}),e.jsx(Ba,{children:e.jsx(me,oe($({},$a.responseNumber),{values:{responseIndex:1,display_label:g?" ".concat(g):""}}))})]}),e.jsxs(e.Fragment,{children:[ee!=null&&!k&&e.jsx(Oa,{clientThreadId:c.conversation.id,messages:v,isParagen:!0}),e.jsx(Ns,oe($({},c),{allMessages:v,groupedMessagesToRender:G,allGroupedMessages:G,isUserTurn:k,isFinalUserTurn:!1,isFinalAssistantTurn:!1,isCompletionRequestInProgress:h,hasActiveRequest:m,shouldGrowContainer:!1,isParagen:!0})),e.jsx(Wa,{clientThreadId:c.conversation.id,conversationTurnMountTime:c.conversationTurnMountTime,turn:t,originalTurn:u})]})]}),e.jsxs(Ua,{rootElementRef:N,onClick:()=>{s(o)},hasActiveRequest:m,isImageGenInProgress:O,children:[e.jsxs(Ga,{children:[e.jsx(_a,{messages:P,isUserTurn:W,avatarClassName:b}),e.jsx(Ba,{children:e.jsx(me,oe($({},$a.responseNumber),{values:{responseIndex:2,display_label:L?" ".concat(L):""}}))})]}),e.jsxs(e.Fragment,{children:[ee!=null&&!W&&e.jsx(Oa,{clientThreadId:c.conversation.id,messages:P,isParagen:!0}),e.jsx(Ns,oe($({},c),{allMessages:P,groupedMessagesToRender:j,allGroupedMessages:j,isFinalUserTurn:!1,isFinalAssistantTurn:!1,isUserTurn:W,isCompletionRequestInProgress:M,hasActiveRequest:m,shouldGrowContainer:!1,isParagen:!0})),e.jsx(Wa,{clientThreadId:c.conversation.id,conversationTurnMountTime:c.conversationTurnMountTime,turn:i,originalTurn:u})]})]})]})})]})}function Ua({rootElementRef:s,onClick:n,children:o,hasActiveRequest:t,isImageGenInProgress:i}){const m=r.useRef(null),u=r.useRef(null),p=r.useRef(null);return e.jsx("div",{"data-paragen-root":!0,className:"border-token-border-tertiary @container relative flex min-w-[min(450px,80cqw,80vw)] flex-1 snap-center flex-col gap-1 rounded-xl border text-start shadow-lg shadow-black/3",ref:s,children:e.jsxs("div",{className:pe(ai,"px-(--thread-content-margin) py-4"),children:[e.jsx("div",{className:pe("absolute top-48 right-0! left-0! h-px","invisible"),ref:m}),e.jsx("div",{className:pe("absolute top-48 right-0! bottom-0 left-0!","invisible"),ref:u}),e.jsx("div",{className:pe("absolute right-0! bottom-0 left-0! h-px","invisible"),ref:p}),o,t||i?null:e.jsx(un,{className:"mt-4 self-start",onClick:n,"data-testid":"paragen-prefer-response-button",children:e.jsx(me,{id:"U2EAH6",defaultMessage:"I prefer this response"})})]})})}var Ja;const Ba=rn.div(Ja||(Ja=js(["text-sm text-token-text-secondary font-semibold"])));var Ya;const Ga=rn.div(Ya||(Ya=js(["flex gap-4 items-center mb-1"])));function Wa({clientThreadId:s,conversationTurnMountTime:n,turn:o,originalTurn:t}){var g,L,v,P,b,C;const i=mn();if(!i.showParagenMetadata||!i.showDebugConversationTurns&&!i.forceParagen||o==null)return null;let m=o===t?"ORIGINAL":"NEW";const u=o.messages[o.messages.length-1],p=(g=u==null?void 0:u.metadata)==null?void 0:g.__internal,c=(L=u==null?void 0:u.metadata)==null?void 0:L.paragen_display_label;if(p){const{model_id:G,model_definition_slug:j,model_definition_virtual_model_id:K,alternative_model_selection_rule:V,augmented_paragen_prompt_group_id:F,augmented_paragen_prompt_id:D,augmented_paragen_prompt:E}=p;G&&(m+="\nModel ID: ".concat(G)),j&&(m+="\nModel Slug: ".concat(j)),K&&(m+="\nVirtual Model ID: ".concat(K)),V&&(m+="\nAlternative Model Rule: ".concat(V)),F&&(m+="\nPrompt Group ID: ".concat(F)),D&&(m+="\nPrompt ID: ".concat(D)),E&&(m+="\nPrompt: ".concat(E)),c&&(m+="\nDisplay Label: ".concat(c))}m+="\nMessage ID: ".concat(u.id);const w=B.getParentPromptNode(ls(s),o.messages[0].id);if(!w)throw new Error("Expected prompt for side by side feedback");const y=((v=w.message.clientMetadata)==null?void 0:v.variantsInStreamInfo)==null&&((P=w.message.metadata)==null?void 0:P.paragen_variants_info)!=null;return m+="\nUser prompt message ID: ".concat(w.message.id),m+="\nIs Persisted Paragen? ".concat(y),m+="\nCompletion Sample Finish Time: ".concat(y?"".concat(n," (persisted)"):(C=(b=A(o.messages))==null?void 0:b.clientMetadata)==null?void 0:C.completionSampleFinishTime),e.jsx("div",{className:"text-sm whitespace-pre-wrap text-red-500",children:m})}async function qa({params:s}){await Ls.safePost("/paragen_submission",{requestBody:s,authOption:Vr.SendIfAvailable})}const $a=Do({responseNumber:{id:"ConversationTurnTwoUpFeedback.responseNumber",defaultMessage:"Response {responseIndex, number}{display_label}"}}),$l=Z(()=>Y(()=>import("./m360psfv67etw60z.js").then(s=>s._),__vite__mapDeps([13,1])),{loading:s=>xe(s)}),zl=Z(()=>Y(()=>import("./nt70i7v0q9til63b.js"),__vite__mapDeps([8,1,5,6,9,10,11,12])).then(s=>s.MemoryActionResult)),Kl=Z(()=>Y(()=>import("./lkw8iwfdfi4ojt36.js"),__vite__mapDeps([14,1,5,6,9,10,15])).then(s=>s.AutomationSourceHeader)),za=Z(()=>Y(()=>import("./ot1i36fs7pr1r2qj.js"),__vite__mapDeps([16,1,5,6,17,9,10])).then(s=>s.TextMessageEditor)),Ql=Z(()=>Y(()=>import("./hkwy60i7c1zytn8i.js"),__vite__mapDeps([18,1,5,6,9,10,19,20,21,22,23])).then(s=>s.ChatScreenRetrievalResultsFlyoutContent)),Ka=80,Rs=16;function Qa(){return{minHeight:"calc(100dvh - ".concat(lr,"px - 120px)")}}function Xl(s){"use no forget";var vt,bt,It,St,Ct,Tt,yt,Mt,wt,jt,Et,Pt,kt,Rt,At,Ft,Nt,Dt,Ot,Lt,Ht,Vt,Ut,Bt,Gt,Wt,qt,$t,zt,Kt,Qt,Xt,Jt,Yt,Zt,ea,sa,ta,aa;const{turnIndex:n,isFinalTurn:o,conversation:t,onRequestCompletion:i,currentModelId:m,scrollToMessageId:u,scrollToMessageIsAssistant:p,dateHeaderType:c,hideUserActions:w,disableHorizontalPadding:y}=s,g=We(),L=en(g),v=Ur(),P=Br(),b=Gr(a=>Us(a)),C=Wr(g),G=!!v&&qr(v),j=$r(zr.isBusinessWorkspace),K=ni(),V=oi(g)||K,F=ii(g),D=ri(g),{eligible:E}=li(di.hasSeenAudioParagenPrompt),[h,M,T]=be(t.id,a=>{const d=B.getConversationTurnAtIndex(a,n),_=n>0?B.getConversationTurnAtIndex(a,n-1):null,S=(_==null?void 0:_.role)===z.User&&_.messages.some(q=>{var ne;return(ne=q.metadata)==null?void 0:ne.visually_hide_response_from_conversation});return[d,S,_]},{disablePerfDetector:o}),{messages:f,messageGroups:O}=h,k=ci(a=>a.size===0?-1:O.findIndex(d=>d.type===Ps?d.groups.some(_=>_.messages.some(S=>a.has(S==null?void 0:S.id))):d.messages.some(_=>a.has(_==null?void 0:_.id)))),W=f[0],l=A(f),Q=r.useMemo(()=>O.some(a=>a.type===Kr.SearchGPTQuery),[O]),N=r.useMemo(()=>f.some(a=>{var d;return(d=a.metadata)==null?void 0:d.n7jupd_message}),[f]),ge=r.useMemo(()=>f.some(a=>{var d;return(d=a.metadata)==null?void 0:d.mercury_message}),[f]),R=r.useMemo(()=>{var a,d;return(d=(a=A(f))==null?void 0:a.metadata)==null?void 0:d.chatgpt_sdk_suppressed_response},[f]),ee=r.useMemo(()=>N?Qr(f,a=>a.author.name==="n7jupd.metadata"):null,[f,N]),ie=!!((vt=ee==null?void 0:ee.metadata)!=null&&vt.kaur1br5_mode),Se=be(t.id,a=>!!(a!=null&&a.pulseCardId)),Ce=te(()=>an(g).isFeedbackModalOpen$()||Se&&n===1),{messages:x,visibleMessages:X,messageGroups:se,lastMessageToRender:I}=r.useMemo(()=>{const a=k!==-1&&k+1<O.length,d=a?O.slice(0,k+1):O,_=a?d.flatMap(S=>S.type===Ps?S.groups.flatMap(q=>q.messages):S.messages):f;return{messages:_,visibleMessages:_.filter(Xr),messageGroups:d,lastMessageToRender:A(_)}},[f,O,k]),re=k!==-1,le=Ne(g,"1887864177"),J=be(t.id,a=>B.getLastMessageSystemHints(a)),qe=be(t.id,a=>{var d;return(d=a==null?void 0:a.hasIKConvo)!=null?d:!1}),Pe=(J==null?void 0:J.includes(Ue.Tatertot))&&Ne(g,"28816792")&&Jr(g),{capabilitySuggestionsEnabled:$e}=ui(Pe),Bs=r.useMemo(()=>({clientThreadId:t.id,turnIndex:n,messageId:l==null?void 0:l.id}),[t.id,n,l==null?void 0:l.id]),[Gs,Ws]=r.useState(!1),[qs,fn]=r.useState(!1),xn=r.useContext(mi)!=null,U=h.role===z.User,cs=Yr(),Te=Zr(t.id),us=(bt=h.gizmoId)!=null?bt:Te,ye=el(us).data,ms=us&&!sl(us)?ye:void 0,_n=ms&&h.gizmoId!=null&&h.gizmoId!==Te&&Ne(g,"1418300125"),gs=te(()=>Hs(t)),vn=tl(t.id),ze=gi(gs),bn=hi(gs,vn),hs=al(g),[Me,In,Sn,$s,ps,Cn,Ke,Tn,yn,zs,fs,fe,Qe,Xe,Mn,ke,H,wn]=be(t.id,a=>{var na,oa,ia,ra,la;const d=B.getParentPromptNode(a,W.id),_=(ra=(na=d==null?void 0:d.message.clientMetadata)==null?void 0:na.variantsInStreamInfo)!=null?ra:(oa=d==null?void 0:d.message.metadata)!=null&&oa.paragen_variant_choice||(ia=d==null?void 0:d.message.metadata)==null?void 0:ia.paragen_variants_info,S=B.getVariantIds(a,W.id),q=B.getCurrentVariantId(a,W.id),ne=q?S.indexOf(q):0,Ee=_&&(a==null?void 0:a.tree)!=null&&S.some(ue=>{var ca;const{errType:da}=(ca=a.tree.getLeafFromNode(ue).message.clientMetadata)!=null?ca:{};return da!=null&&da!=="info"}),ce=B.getConversationTurns(a),Ve=ce.findIndex(ue=>ue.role===z.Assistant),ko=Na(ce,ue=>ue.role===z.Assistant),Ro=ce.slice(Ve,n+1).every(ue=>ue.role===z.Assistant);return[d,l!=null&&!_l(l.id)&&B.isMessageTurnEnded(a,l.id),Ee,dr(a==null?void 0:a.mode,ye==null?void 0:ye.gizmo.id),ce.findIndex(ue=>ue.role===z.User)===n,Na(ce,ue=>ue.role===z.User)===n,Ve===n,ko===n,Ro,B.getRequestId(a,l==null?void 0:l.id),_,S,ne,!!(a!=null&&a.continuingFromSharedPostId),a==null?void 0:a.currentLeafId,B.getSuperWidgetMessages(a,n)[0],B.lastUserMessage(a),(la=a==null?void 0:a.continuingFromSharedProjectConversationId)!=null?la:null]},{disablePerfDetector:o}),we=sn(),Je=te(()=>{const a=cr(t);return(a==null?void 0:a.value)===ns.STREAMING||(a==null?void 0:a.value)===ns.REALTIME}),jn=x.some(a=>a.content.content_type===is.MultimodalText),En=nl(g,"3119715334").get("should-enable-skip",!1),{isUnauthenticated:Ks}=on(),Qs=h.messages.map(a=>a.id),de=r.useRef(null);Jl({clientThreadId:t.id,turn:h,turnIndex:n,conversationTurnWrapperRef:de});const Xs=!L&&((It=u==null?void 0:u.length)!=null?It:0)>2&&u!=="finalAgentTurn"&&o,ae=U?A(X):void 0,xs=ae==null?void 0:ae.id,Pn=r.useCallback(()=>{xs&&(De.logEvent("Edit Prompt",{id:xs,threadId:Ge(t.id)}),Be(g,"chatgpt_edit_prompt"),Ws(!0))},[g,xs,t.id]),kn=r.useCallback(()=>{Ws(!1)},[]),{hasConnections:Js}=ol(),{onChangeRating:Rn}=pi({clientThreadId:t.id,currentModelConfig:gs}),An=a=>{var q;if(!l)return;const d=(q=l.clientMetadata)==null?void 0:q.rating,S=(d==="thumbs_up"?"thumbsUp":d==="thumbs_down"?"thumbsDown":d)===a?null:a;if(Rn({nodeId:l.id,messageId:l.id,rating:S}),S){const ne=Js&&O.some(Ee=>{var ce;return Ee.type!==Ps&&((ce=Ee.messages)==null?void 0:ce.some(xl))});De.logEventWithStatsig(S==="thumbsDown"?"Message Feedback Thumbs Down Clicked":"Message Feedback Thumbs Up Clicked","chatgpt_thumb_feedback",$($({id:l.id,threadId:Ge(t.id),model:m,rating:S},Js?{isCATriggered:ne}:{}),b?{isSidebar:!0}:{}))}fn(S==="thumbsDown")},[Fn]=r.useState(()=>Date.now()),Oe=il(t.id),Ys=(Ct=Oe!=null?Oe:wn)!=null?Ct:we&&(St=t.sharedConversationId)!=null?St:null,Zs=(Tt=fi(t.id))==null?void 0:Tt.value,et=Zs===ns.STREAMING,Nn=Zs===ns.REALTIME,Dn=zs!=null,On=ln(zs),Ln=ba.useState(a=>ba.isReplayInProgress(a,Mn)),he=!In&&On||re||et||Nn||Ln&&o||f.some(a=>xi(a)),st=dn(),_s=r.useRef(!1),tt=r.useRef(void 0),Hn=rl({clientThreadId:t.id}),Vn=_i(t.id,l)&&!Hn,[,Un]=Oo(),{isOpen:Ye}=As(),at=gn(),Re=A(T==null?void 0:T.messages.filter(ll)),vs=vi({clientThreadId:t.id,threadContent:(yt=ke==null?void 0:ke.content)!=null?yt:null,query:Re?ks(Re):null,triggeredSearch:Q,messageGroups:se,allMessages:f}),Ae=te(()=>vl(g)&&Ke&&(!J||J.length===0||J.includes(Ue.Search)))&&vs.showNavlinksWidget,nt=x.filter(ka),Bn=Ae&&nt.length===0&&!N,ot=((Mt=H==null?void 0:H.author.metadata)==null?void 0:Mt.real_author)==="onboarding",it=C&&Ke&&Ae&&vs.showLongList;r.useEffect(()=>{const d=new URLSearchParams(window.location.search).get("message");!(d!=null&&Qs.includes(d))||!de.current||(de.current.scrollIntoView({behavior:"instant"}),Un(S=>(S.delete("message"),S),{replace:!0,preventScrollReset:!0}))},[]),r.useEffect(()=>{u!==tt.current&&(_s.current=!1,tt.current=u)},[u]),r.useEffect(()=>{if(L)return;const _=new URLSearchParams(window.location.search).get("message")!=null;if(_s.current||_||u===void 0||!de.current||at||ot||it){u==="finalAgentTurn"&&o&&Ie(t.id,S=>{S.scrollToMessageId=void 0});return}(Qs.includes(u)||u==="finalAgentTurn"&&o)&&(_s.current=!0,requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(de.current)if(u==="finalAgentTurn"&&o)de.current.scrollIntoView({behavior:"instant",block:"end"}),Ie(t.id,S=>{S.scrollToMessageId=void 0});else{const S=de.current.offsetHeight;let q=0;Ye?q=-8:C?q=-1*Rs:p?q=-8:S>Ka&&(q=Ka-S);const ne=bi(t).pinnedWidgetHeight$();ne!=null&&(q+=ne+Rs),de.current.style.scrollMarginTop="".concat(q+Rs,"px"),de.current.scrollIntoView({behavior:"smooth"})}})}))},[u,p,de.current,Ye,at,ot,it]);const{showDebugConversationTurns:Gn}=mn(),Wn=!we&&!Xe&&!cs&&!U,qn=(I==null?void 0:I.author.role)===z.Assistant?I:null,$n=(jt=(wt=I==null?void 0:I.metadata)==null?void 0:wt.system_hints)==null?void 0:jt.includes(Ue.Research),zn=(Pt=(Et=I==null?void 0:I.metadata)==null?void 0:Et.system_hints)==null?void 0:Pt.includes(Ue.Agent);Ii({isCompletionRequestInProgress:he,isUserTurn:U,message:qn});const{isOpen:Kn}=As(),Qn=Si(g),Ze=Ci($s),Xn=Ti(a=>a.voiceFeedbackThread),rt=Oe===Xn,Jn=(kt=l==null?void 0:l.metadata)==null?void 0:kt.async_source,es=o&&Dn,_e=Je||he||et,Yn=X.length===0&&x.some(dl),Zn=((Rt=yi(X))==null?void 0:Rt.author.name)===Ra.A8KM123&&Mi(X,a=>a.author.name===Ra.A8KM123||a.channel==="commentary"||a.author.role===z.Developer),bs=!Gs&&!x.every(cl)&&!we&&!Xe&&!Ze&&!Kn&&h.role!==z.Developer&&!(h.role===z.User&&w)&&!(o&&rt&&_e)&&!(es&&_e)&&!(o&&Je&&Jn)&&!(_e&&N)&&!(Zn&&!o)&&!((At=l==null?void 0:l.metadata)!=null&&At.is_auto_proceed_message)&&!((Ft=l==null?void 0:l.metadata)!=null&&Ft.is_takeover_ended_message)&&!((Nt=l==null?void 0:l.metadata)!=null&&Nt.disable_turn_actions)&&!Bn&&!h.userContinuationSuccessorTurnId&&!R,eo=!bs&&!(es&&_e)&&(we||Xe)&&!b,so=x.some(a=>ul(a)===ml.l1239dk1),Is=be(t.id,a=>{var S,q;const d=new Set,_=B.getParentPromptNode(a,W.id);return(q=(S=_==null?void 0:_.message.metadata)==null?void 0:S.attachments)==null||q.forEach(ne=>{var Ee,ce,Ve;(Ee=ne.mime_type)!=null&&Ee.startsWith("image/")||d.add((Ve=(ce=ne.context_connector_info)==null?void 0:ce.context_connector)!=null?Ve:"file")}),d}),Ss=gl(),Cs=Aa(g,"110789670");let je;Ss.isLoading?je=void 0:Ss.canUpgradeGDrive&&Is.has(os.GDRIVE)&&Cs.get("enabled",!1)?je=os.GDRIVE:Ss.canUpgradeSharepoint&&Is.has(os.O365_BUSINESS)&&Cs.get("enabled",!1)?je=os.O365_BUSINESS:Is.has("file")&&Cs.get("enabled",!1)&&(je="general");const to=(I==null?void 0:I.author.role)===z.Assistant&&((Lt=(Ot=(Dt=I==null?void 0:I.metadata)==null?void 0:Dt.content_references)==null?void 0:Ot.length)!=null?Lt:0)>0||qe,ao=es&&!he&&!b&&!we&&!Xe&&!so&&(le||wi(g)||$e||Pe||!!je),Le=l!=null&&(!j||bn||G||hs)&&!Ze&&!Ks&&!cs&&!((Ht=l.metadata)!=null&&Ht.b1de6e2_s),lt=Je||he,[no,oo]=r.useState(!1),io=!!((Vt=H==null?void 0:H.metadata)!=null&&Vt.dictation&&((Ut=H==null?void 0:H.metadata)!=null&&Ut.dictation_asset_pointer)&&!((Bt=H==null?void 0:H.metadata)!=null&&Bt.dictation_edited)),ro=!!(!E||no||(Gt=H==null?void 0:H.metadata)!=null&&Gt.audio_paragen_result||Ia(H==null?void 0:H.id)),dt=io&&!ro,ct=dt&&(!j||hs)&&Le&&!lt&&!b&&!Ye&&H!=null&&Ke&&Ne(g,"51772912"),lo=ji(H==null?void 0:H.id,ct),ut=ct&&lo,ss=!Ze&&Wn&&o&&(fs==null?void 0:fs.num_variants_in_stream)===2&&fe.length<=2&&!((Wt=l==null?void 0:l.clientMetadata)!=null&&Wt.inlineComparisonRating)&&!Sn&&!dt&&!Ia(H==null?void 0:H.id),mt=!ut&&(!j||hs)&&Le&&(es||o&&rt)&&!lt&&!b&&!Ye&&!N&&!R,gt=!((he||Je)&&o)&&fe.length>1&&!ss,ht=U&&x.some(a=>{var d;return(d=Sa(a))==null?void 0:d.shouldHideContent}),co=U&&ae!=null&&!((qt=ae==null?void 0:ae.metadata)!=null&&qt.async_task_title)&&Oe!=null&&!Ze&&!jn&&!ht&&!Ks&&!$n&&!zn&&!b,uo=l!=null&&Fa.getAudioAssetPointers(l).length>0,mo=l!=null&&((zt=($t=l.clientMetadata)==null?void 0:$t.disclaimers)!=null?zt:[]).length===0&&!b&&(!cs||uo)&&!P,pt=r.useCallback(a=>{var d;Ie(t.id,_=>{Vs.setCurrentBranch(_,fe[a])}),De.logEvent("Change Active Node",{intent:"toggle_between"}),Ne(g,"4126691920")&&Ei({parent_prompt_id:(d=Me==null?void 0:Me.id)!=null?d:"",prev_branch_id:fe[Qe],next_branch_id:fe[a]},Ge(t.id))},[t.id,fe,Qe,Me==null?void 0:Me.id,g]),go=Pi(h,x,Gn),ho=N&&ki(x,o),ts=l==null?void 0:l.id,Ts=r.useCallback(()=>{ts&&Ri(t,{type:"retrievalResults",turnIndex:n,messageId:ts})},[t,ts,n]),Fe=x.some(a=>{var d,_,S;return((d=a==null?void 0:a.metadata)==null?void 0:d.api_tool_type)==="glaux"||hl({id:(S=(_=a==null?void 0:a.metadata)==null?void 0:_.model_slug)!=null?S:""},g)}),ys=r.useMemo(()=>Ai(h,ze,!!Te),[h,ze,Te]),po=r.useMemo(()=>ys&&!Fe,[ys,Fe]),fo=r.useMemo(()=>Fi(h,!!Te,F),[F,Te,h]),ft=Ne(g,"2137702454"),xo=r.useMemo(()=>h.role!==z.User&&ze&&ft&&!Fe,[h,ze,ft,Fe]),_o=pl()&&CSS.supports("content-visibility: auto")&&!U&&Aa(g,"1011775750").get("enabled",!1)&&!Ni(x)&&!ge,vo=r.useMemo(()=>x.some(a=>{var d;return((d=Sa(a))==null?void 0:d.canRetry)===!1}),[x]),bo=(Kt=l==null?void 0:l.metadata)==null?void 0:Kt.n7jupd_button_type,Io=N&&l!=null&&l.id!=null&&!bo,So=N&&o&&_e,Co=N&&o;if(!go&&!ss&&!Ae)return Xs?e.jsx("div",{style:Qa()}):null;if(ho||M)return null;const To=(Qt=I==null?void 0:I.metadata)!=null&&Qt.followup_prompts?I.metadata.followup_prompts.map(a=>({text:a,type:Di.Reply})):[],yo=(Xt=I==null?void 0:I.metadata)==null?void 0:Xt.category_suggestions,Mo=(Jt=I==null?void 0:I.metadata)==null?void 0:Jt.action_suggestions,wo=!x.some(a=>Fa.getAudioAssetPointers(a).length>0)&&!Te&&!vo&&!P&&!Ce,jo=!he&&x.some(a=>{var d,_;return a.author.role===z.Assistant&&((_=(d=a.metadata)==null?void 0:d.onboarding)==null?void 0:_.main_usages)}),Ms=x.find(a=>{var d,_;return!!((_=(d=a.metadata)==null?void 0:d.onboarding)!=null&&_.examples)}),ws=(Zt=(Yt=Ms==null?void 0:Ms.metadata)==null?void 0:Yt.onboarding)==null?void 0:Zt.examples,xt=!ht&&(!o||!he);if(!o&&nt.length===0&&!N&&!Ae)return null;let He="none";U&&ps&&(He="first");const Eo=T==null?void 0:T.messages.some(ka);U&&!ps&&(Eo?He="large":He="none"),o&&(He="last");const _t=C?Oi(f):void 0,Po=(()=>{if(h.userContinuationSuccessorTurnId)return"mb-1";if(U&&!bs&&!b)return"mb-10";if(!U&&b&&o)return"pb-[40px]"})();return e.jsx(Li.Provider,{value:Ke,children:e.jsxs(Hi,{children:[e.jsx(Vi,{dateHeaderType:c,turn:h}),e.jsxs("article",{className:pe("text-token-text-primary w-full focus:outline-none","[--shadow-height:45px] has-data-writing-block:pointer-events-none has-data-writing-block:-mt-(--shadow-height) has-data-writing-block:pt-(--shadow-height) [&:has([data-writing-block])>*]:pointer-events-auto",_o&&"[content-visibility:auto] supports-[content-visibility:auto]:[contain-intrinsic-size:auto_100lvh]",!L&&u==="finalAgentTurn"?"opacity-0":"",{hidden:xn&&ps},U?"scroll-mt-(--header-height)":"scroll-mt-[calc(var(--header-height)+min(200px,max(70px,20svh)))]"),tabIndex:-1,style:Xs?Qa():void 0,ref:de,dir:"auto","data-turn-id":h.id,"data-testid":"conversation-turn-".concat(n),"data-scroll-anchor":!L&&o,"data-turn":U?"user":"assistant",children:[e.jsx(Ui,{role:h.role,gizmo:ms}),e.jsx(Bi,{role:h.role,children:e.jsxs(tn,{horizontalPadding:ss||y?"none":"standard",verticalPadding:He,children:[ss?e.jsxs(e.Fragment,{children:[e.jsx(Wl,$({isFeedbackEnabled:Le,variantIds:fe,conversationTurnMountTime:Fn},s)),En&&e.jsx("div",{className:"mt-4 flex w-full justify-center",children:e.jsxs(un,{color:"secondary",className:"text-token-text-primary","data-testid":"paragen-skip-button",onClick:()=>{cn.publish({kind:"requestCompletion",isForSkippingParagen:!0})},children:[e.jsx($l,{className:"text-token-text-secondary me-1"}),e.jsx(me,{id:"IuTr+b",defaultMessage:"Skip"})]})})]}):e.jsxs(Fs,{tabIndex:-1,className:pe("group/turn-messages focus-visible:outline-hidden",Ae&&"super-widget-visible",Po,nr({isUserTurn:U})),children:[_n&&e.jsx(Gi,{gizmo:ms}),Ae&&e.jsx(Wi,{clientThreadId:t.id,query:Re?ks(Re):null,state:vs}),xo&&e.jsx(qi,{handleShowRetrievalResults:Ts,clientThreadId:t.id,turnIndex:n,responseComplete:!_e,className:"mb-6"}),!U&&e.jsx(zl,{messages:x,clientThreadId:t.id,gizmoId:ye==null?void 0:ye.gizmo.id}),x.some(a=>{var d,_,S;return(S=(d=a.metadata)==null?void 0:d.async_completion_id)!=null?S:U&&((_=a.metadata)==null?void 0:_.async_task_title)})&&e.jsx($i,{message:x.find(a=>{var d,_,S;return(S=(d=a.metadata)==null?void 0:d.async_completion_id)!=null?S:U&&a.author.role===z.User&&((_=a.metadata)==null?void 0:_.async_task_title)}),clientThreadId:t.id,isUserTurn:U}),Qn&&U&&e.jsx(Kl,{clientThreadId:t.id,messages:x}),Gs&&ae?e.jsx(za,{message:ae,clientThreadId:t.id,onRequestCompletion:i,onExitEdit:kn,disabled:st}):e.jsx(Ns,oe($({allMessages:f,groupedMessagesToRender:se,allGroupedMessages:O},s),{isUserTurn:U,isFinalUserTurn:Cn,isFinalAssistantTurn:Tn,isWithinFirstAssistantTurns:yn,isCompletionRequestInProgress:he,isFeedbackEnabled:Le,isFinalTurn:o,isGlauxTurn:Fe,hasActiveRequest:st,isAgentTurn:N,isMercuryTurn:ge,isKAUR1BR5:ie,query:Re?ks(Re):null,wasInterrupted:Yn,superWidgetContent:(ea=ke==null?void 0:ke.content)!=null?ea:null,lastAgentMetadataNode:ee,hasSearchSystemHint:(sa=J==null?void 0:J.includes(Ue.Search))!=null?sa:!1})),po&&(V&&fo?e.jsx(Ql,{turnIndex:n,clientThreadId:t.id,variant:"bottom"}):e.jsx(Ca,{handleShowRetrievalResults:Ts,clientThreadId:t.id,turnIndex:n,responseComplete:!_e})),Io&&e.jsx(zi,{message:l,clientThreadId:t.id,turnIndex:n,referenceMessageId:l.id,responseComplete:!o||!he}),jo&&e.jsx(Ki,{clientThreadId:t.id}),ws&&ws.length>0&&!he&&e.jsx(Qi,{clientThreadId:t.id,examples:ws}),_t&&e.jsx(Xi,{message:_t,className:"mt-4"}),bs&&e.jsx(yl,{isUserTurn:U,alwaysShow:!0,children:U?b?null:e.jsx(Ml,{activeVariantIndex:Qe,clientThreadId:t.id,numVariants:fe.length,onAnticipateEdit:za.prefetch,onChangeIndex:pt,onEnterEdit:Pn,showCopyButton:xt,showEditMessageButton:co,showPagination:gt,turnIndex:n,reportableMessageId:(ta=ae==null?void 0:ae.id)!=null?ta:null,isSharedConversation:we,serverThreadIdForReporting:Ys}):e.jsxs(e.Fragment,{children:[e.jsx(wl,{activeVariantIndex:Qe,clientThreadId:t.id,conversationMode:$s,lastMessage:l,messages:x,numVariants:fe.length,onChangeIndex:pt,onRate:An,showCanvasButton:Vn,showCopyButton:xt,showPagination:gt,showPlayButton:mo,showRatingButtons:Le,showRegenerateButton:wo,turn:h,turnIndex:n,parentPrompt:Me,isAgentTurn:N,isKAUR1BR5:ie,reportableMessageId:(aa=l==null?void 0:l.id)!=null?aa:null,isSharedConversation:we,serverThreadIdForReporting:Ys}),Fe&&ys?e.jsx(Ca,{handleShowRetrievalResults:Ts,clientThreadId:t.id,turnIndex:n,responseComplete:!_e}):e.jsx(e.Fragment,{children:!D&&e.jsx(Ta,{clientThreadId:t.id,message:l,turnIndex:n,isAgentTurn:N})}),mt&&e.jsx(Ji,{canShowInlineMessageFeedback:qs,clientThreadId:t.id,messageForRating:l}),!1]})}),So&&e.jsx(Yi,{clientThreadId:t.id}),Co&&e.jsx(Zi,{clientThreadId:t.id,messages:x}),eo&&e.jsx(Ta,{clientThreadId:t.id,message:l,turnIndex:n,isAgentTurn:N}),mt&&e.jsx(er,{canShowInlineMessageFeedback:qs,clientThreadId:t.id,messageForRating:l,allGroupedMessages:O,currentModelId:m}),e.jsx(fl,{mode:"wait",children:ut&&e.jsx(sr,{lastUserMessageId:H.id,setIsDismissed:oo})}),ao&&(je?e.jsx(tr,{clientThreadId:t.id,connectorToUpsell:je,analyticsMetadata:Bs}):e.jsx(ar,{followups:To,actionSuggestions:Mo,categorySuggestions:yo,clientThreadId:t.id,lastMessageId:ts,analyticsMetadata:Bs,isTatertotFollowupsEnabled:Pe,shouldHideFollowups:to}))]}),e.jsx(or,{clientThreadId:t.id,turn:h,isFinalTurn:o}),e.jsx(ir,{clientThreadId:t.id,turn:h})]})})]})]})})}const Jl=({clientThreadId:s,turn:n,turnIndex:o,conversationTurnWrapperRef:t})=>{const i=rr();r.useEffect(()=>{if(!i)return;const m=new IntersectionObserver(u=>{u.forEach(p=>{p.isIntersecting?Ie(s,c=>{var w;c.turnIdsInViewpoint=[...(w=c.turnIdsInViewpoint)!=null?w:[],{turnId:n.id,turnIndex:o,role:n.role}]}):Ie(s,c=>{var w;c.turnIdsInViewpoint=(w=c.turnIdsInViewpoint)==null?void 0:w.filter(({turnId:y})=>y!==n.id)})})},{root:null,threshold:.1});return t.current&&m.observe(t.current),()=>{Ie(s,u=>{var p;u.turnIdsInViewpoint=(p=u.turnIdsInViewpoint)==null?void 0:p.filter(({turnId:c})=>c!==n.id)}),m.disconnect()}},[s,t,i,n.id,n.role,o])},Yl=Za.memo(Xl),Xa=Z(()=>Y(()=>import("./pcwyhd2ia1xnez4s.js"),__vite__mapDeps([24,1,5,6,9,10])).then(s=>s.ThreadReportConversationModal));function pd(s){const{prefetchNavlink:n,clearPrefetchNavlink:o,conversation:t,pageLoadSearchQuery:i}=s,m=We(),u=en(m),p=ur(t.id),c=mr(),w=gr(),[y,g]=te(()=>[Tl(m),Us(m)]),[L]=hr(),{isOpen:v}=As(),P=w.store.useContentAreaDimensions(pr.Header,j=>j!=null&&j.height?j.height:void 0);let b=null;P||(b=!u&&v?"max-sm:pb-25":"pb-25",y?b=L===fr.Chat?"pb-12":"pb-13":g&&(b="pb-0"));let C=e.jsx(Zl,$({isNewScrollEnabled:u},s));const G=xr();return G&&(C=e.jsx(_r,{clientThreadId:t.id,children:C})),C=e.jsx(vr,{clientThreadId:t.id,children:C}),e.jsxs("div",{onCopy:p,className:pe("flex flex-col text-sm",G?"pt-4":g?"thread-xl:pt-0 pt-0":"thread-xl:pt-header-height",c&&"keyboard-open:pb-[calc(var(--composer-height,100px)+var(--screen-keyboard-height,0))]",b),style:{paddingBottom:P},children:[i&&e.jsx("div",{children:e.jsx(El,{query:i})}),n?e.jsx(bl,{name:"prefetch-navlink",onError:j=>{rs.addError("Error with prefetch navlink",{error:j}),o()},children:e.jsx(r.Suspense,{fallback:null,children:e.jsx(Pl,{clientThreadId:t.id,prefetchNavlink:n,clearPrefetchNavlink:o})})}):null,e.jsx(Il,{children:C})]})}function Zl({onRequestCompletion:s,conversation:n,scrollContainerRef:o,isNewScrollEnabled:t}){var W,l,Q,N,ge;const i=We(),m=te(()=>Us(i)),[u,p,c,w,y,g]=be(n.id,R=>[B.getConversationTurnIds(R),R==null?void 0:R.pulseCardId,R==null?void 0:R.scrollToMessageId,R==null?void 0:R.scrollToMessageIsAssistant,B.hasUserMessage(R),B.isMessageTurnEnded(R)]),L=an(i),v=te(()=>ya(i)&&L.isCardModalOpen$()),P=te(()=>ya(i)&&L.isFeedbackModalOpen$()),b=te(()=>wr(i)),{data:C}=br(p),G=p&&!y,j=sn(),K=gn(),V=Sl(),F=te(()=>Hs(n));Ir({isSharedConversation:j,clientThreadId:n.id}),r.useEffect(()=>{j&&(Be(i,"chatgpt_continue_conversation_page_loaded"),De.logEvent("Continue Conversation: Page Loaded"),Be(i,"chatgpt_conversation_share_page_loaded"),De.logEvent("Share Public Chat: Shared Conversation Loaded"))},[i,j]);const D=te(()=>n.id?jr(n).activeSystemHintSuggestionChips$():[]),[E,h]=r.useState(!1),[M,T]=r.useState(!1),f=r.useRef(null),O=Sr(n.id),k=K&&!V;return e.jsxs(e.Fragment,{children:[P&&e.jsx(Cr,{}),k&&e.jsx(Gl,{}),j&&e.jsxs(e.Fragment,{children:[e.jsx(Fs,{children:e.jsx("p",{className:"text-xs text-gray-500",children:e.jsx(me,{id:"threadLayout.sharedConversationCopyDisclaimer",defaultMessage:"This is a copy of a conversation between ChatGPT & Anonymous."})})}),e.jsx("div",{className:"text-token-text-primary mb-5 text-center text-xs font-semibold",children:e.jsx("button",{onPointerOver:()=>Xa.prefetch(),onClick:()=>{Cl(i,Xa,{clientThreadId:n.id,serverThreadId:n.sharedConversationId,isSharedConversation:!0,isStaticSharedThread:!1}),Be(i,"chatgpt_conversation_share_report_content_clicked",void 0,{location:"Static Shared Thread Page"}),De.logEvent("Share Public Chat: Report Content Clicked",{location:"Dynamic Shared Thread Page"})},children:e.jsx(me,{id:"thread.reportSharedConversation",defaultMessage:"Report conversation"})})})]}),C&&e.jsx(tn,{horizontalPadding:"standard",horizontalMargin:"none",children:e.jsx(Fs,{children:e.jsx(Tr,{imageSrc:(l=(W=C.image)==null?void 0:W.url)!=null?l:"",fallbackSrc:(N=(Q=C.image)==null?void 0:Q.fallback_url)!=null?N:"",title:(ge=C.title)!=null?ge:"",cardId:p})})}),u.map((R,ee)=>{var ie;return e.jsx(Za.Fragment,{children:e.jsx(Yl,{isFinalTurn:ee===u.length-1,turnIndex:ee,conversation:n,onRequestCompletion:s,currentModelId:(ie=F==null?void 0:F.id)!=null?ie:null,scrollToMessageId:t||G?void 0:c,scrollToMessageIsAssistant:t||G?void 0:w,dateHeaderType:O(ee)},R)},R)}),!t&&e.jsxs(e.Fragment,{children:[(o==null?void 0:o.current)&&e.jsx(Da,{setIsScrolledToEdge:R=>{h(R)},options:{root:o.current,threshold:0,rootMargin:"0%"}},"threadBottomEdgeScrollObserver"),e.jsx("div",{ref:f}),v&&(o==null?void 0:o.current)&&e.jsx(Da,{setIsScrolledToEdge:R=>{T(!R)},options:{root:o.current,threshold:0,rootMargin:"-30px 0px"}},"pulseCardModalEdgeScrollObserver"),v&&e.jsx(yr,{show:M&&g}),e.jsx(Mr,{show:E&&!D.length&&!m&&!P&&!b,className:pe("bottom-[calc(var(--composer-overlap-px)+--spacing(6))]"),onClick:()=>{var R;Be(i,"chatgpt_thread_scroll_to_bottom"),(R=f.current)==null||R.scrollIntoView({behavior:"smooth",block:"end"})}})]})]})}export{Yl as C,gd as P,hd as S,pd as T,hn as a};
//# sourceMappingURL=kj8h59p17s2tn6gp.js.map
