var J=Object.defineProperty,I=Object.defineProperties;var ee=Object.getOwnPropertyDescriptors;var E=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var X=(e,t,n)=>t in e?J(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,O=(e,t)=>{for(var n in t||(t={}))B.call(t,n)&&X(e,n,t[n]);if(E)for(var n of E(t))K.call(t,n)&&X(e,n,t[n]);return e},Q=(e,t)=>I(e,ee(t));var Y=(e,t)=>{var n={};for(var i in e)B.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&E)for(var i of E(e))t.indexOf(i)<0&&K.call(e,i)&&(n[i]=e[i]);return n};import{cn as C,n as te,nM as ne,bQ as ie,cJ as oe,co as F,bX as re}from"./ghewn7l2ynbm32fm.js";import{bR as se,bO as p,bX as ae}from"./j0yo6uv6652vva62.js";import{f as de,v as ce}from"./i8clt0mfz495j7ii.js";const h=de({starting:{id:"jitPluginMessage.starting",defaultMessage:"Starting action"},confirmingSimple:{id:"jitPluginMessage.confirming.simple",defaultMessage:"{gizmoName} wants to talk to {domain}"},confirmingSubtitle:{id:"jitPluginMessage.confirming.subtitle",defaultMessage:"Only allow sites you trust."},running:{id:"jitPluginMessage.runningV4",defaultMessage:"Talking to {domain}"},finished:{id:"jitPluginMessage.finishedV4",defaultMessage:"Talked to {domain}"},stopped:{id:"jitPluginMessage.stoppedV4",defaultMessage:"Stopped talking to {domain}"},error:{id:"jitPluginMessage.errorV5",defaultMessage:"Error talking to {domain}"},declined:{id:"jitPluginMessage.declined",defaultMessage:"You declined this action"},ranTest:{id:"jitPluginMessage.ranTest",defaultMessage:"Tested {operationName}"},confirmParamsTitle:{id:"jitPluginMessage.confirmParamsTitleV3",defaultMessage:"{gizmoName} wants to share this info with {domain}"},sentParamsTitle:{id:"jitPluginMessage.sentParamsTitleV2",defaultMessage:"{gizmoName} sent this info to {domain}"},privacyPolicyLink:{id:"jitPluginMessage.privacyPolicyLinkV2",defaultMessage:"Privacy policy"},connectorDeclined:{id:"jitPluginMessage.connectorDeclined",defaultMessage:"Declined connection to {domain}"},rememberForThisConversation:{id:"jitPluginMessage.rememberForThisConversation",defaultMessage:"Remember for this conversation"},allow:{id:"jitPluginMessage.allow",defaultMessage:"Allow"},allowing:{id:"jitPluginMessage.allowing",defaultMessage:"Allowingâ€¦"}});var u=(e=>(e[e.Running=0]="Running",e[e.Finished=1]="Finished",e[e.Error=2]="Error",e[e.Stopped=3]="Stopped",e[e.OauthLogin=4]="OauthLogin",e[e.NoAuthLink=5]="NoAuthLink",e[e.UserConfirmation=6]="UserConfirmation",e[e.Denied=7]="Denied",e[e.Hidden=8]="Hidden",e))(u||{});const ue=e=>{const[t,...n]=e,i=n.filter(f=>f.author.role===F.Tool),o=i.filter(f=>{var d,s,_;return((_=(s=(d=f.metadata)==null?void 0:d.jit_plugin_data)==null?void 0:s.from_server)==null?void 0:_.type)==="debug"}),r=i.filter(f=>!["debug","send_test"].some(d=>{var s,_,v;return d===((v=(_=(s=f.metadata)==null?void 0:s.jit_plugin_data)==null?void 0:_.from_server)==null?void 0:v.type)})),a=i[i.length-1];return{assistantMessage:t,toolMessages:i,debugMessages:o,actionableMessages:r,lastToolMessage:a}},Z=new WeakMap,x=e=>{const t=Z.get(e);if(t)return t;const n=ue(e);return Z.set(e,n),n};function fe(e){if(e&&"user_action"in e){const t=e.user_action;e=O(O({},e),t.data),"target_message_id"in e&&t.target_message_id&&(e.target_message_id=t.target_message_id)}return e}function $(e,t){var n,i,o,r;return((n=e==null?void 0:e.from_server)==null?void 0:n.type)==="confirm_action"?(o=(i=e==null?void 0:e.from_server)==null?void 0:i.body)==null?void 0:o.operation:(r=t==null?void 0:t.parsed_function_call)==null?void 0:r.name}function Ae(e,t){var r,a;const{jitPluginData:n,invokedPlugin:i,lastConfirmActionJitPluginData:o}=N(e,t);return(a=(r=$(n,i))!=null?r:$(o,void 0))!=null?a:""}function ke(e,t){var n,i,o,r;return((n=e==null?void 0:e.from_server)==null?void 0:n.type)==="confirm_action"?(o=(i=e==null?void 0:e.from_server)==null?void 0:i.body)==null?void 0:o.params:(r=t==null?void 0:t.parsed_function_call)==null?void 0:r.kwargs}function N(e,t){var r,a,f,d,s,_,v,y,A,k,b,M,S,j,w,R,z,V,q;const{assistantMessage:n,actionableMessages:i}=x(e);let o;for(let g=i.length-1;g>=0;g--){const c=(r=i[g].metadata)==null?void 0:r.jit_plugin_data;if(((a=c==null?void 0:c.from_server)==null?void 0:a.type)==="confirm_action"){o=c;break}}if(((s=(d=(f=n.metadata)==null?void 0:f.jit_plugin_data)==null?void 0:d.from_server)==null?void 0:s.type)==="send_test")return{uiState:u.Hidden,lastConfirmActionJitPluginData:o,jitPluginData:void 0,invokedPlugin:void 0,fileAttachments:void 0};if(i.some(g=>g.content.content_type===C.SystemError))return{uiState:u.Error,lastConfirmActionJitPluginData:o,jitPluginData:void 0,invokedPlugin:void 0,fileAttachments:void 0};if(se(n))return{uiState:u.Stopped,lastConfirmActionJitPluginData:o,jitPluginData:void 0,invokedPlugin:void 0,fileAttachments:void 0};for(let g=i.length-1;g>=0;g--){const c=i[g];if((_=c.metadata)!=null&&_.invoked_plugin){const H=[];return i.forEach(U=>{var G,L;const W=(L=(G=U.metadata)==null?void 0:G.attachments)==null?void 0:L.filter(D=>D.display_files_from_actions_ext);W&&H.push(...W)}),{uiState:u.Finished,lastConfirmActionJitPluginData:o,jitPluginData:c.metadata.jit_plugin_data,invokedPlugin:c.metadata.invoked_plugin,fileAttachments:H}}const l=fe((y=(v=c.metadata)==null?void 0:v.jit_plugin_data)==null?void 0:y.from_client);if(l!=null){if((l==null?void 0:l.type)==="contact_gizmo")return{uiState:u.Finished,lastConfirmActionJitPluginData:o,jitPluginData:(k=(A=i[g-1])==null?void 0:A.metadata)==null?void 0:k.jit_plugin_data,invokedPlugin:void 0,fileAttachments:void 0};if((l==null?void 0:l.type)==="deny")return{uiState:u.Denied,lastConfirmActionJitPluginData:o,jitPluginData:void 0,invokedPlugin:void 0,fileAttachments:void 0};if((l==null?void 0:l.type)==="oauth_success")return{uiState:u.Running,lastConfirmActionJitPluginData:o,jitPluginData:(b=c.metadata)==null?void 0:b.jit_plugin_data,invokedPlugin:void 0,fileAttachments:void 0};if((l==null?void 0:l.type)==="link_success")return{uiState:u.Running,lastConfirmActionJitPluginData:o,jitPluginData:(M=c.metadata)==null?void 0:M.jit_plugin_data,invokedPlugin:void 0,fileAttachments:void 0};break}const m=(j=(S=c.metadata)==null?void 0:S.jit_plugin_data)==null?void 0:j.from_server;if((m==null?void 0:m.type)==="preview"&&t)return{uiState:u.Running,lastConfirmActionJitPluginData:o,jitPluginData:(w=c.metadata)==null?void 0:w.jit_plugin_data,invokedPlugin:void 0,fileAttachments:void 0};if((m==null?void 0:m.type)==="confirm_action"&&t)return{uiState:u.UserConfirmation,lastConfirmActionJitPluginData:o,jitPluginData:(R=c.metadata)==null?void 0:R.jit_plugin_data,invokedPlugin:void 0,fileAttachments:void 0};if((m==null?void 0:m.type)==="activate_scope"&&t)return{uiState:u.UserConfirmation,lastConfirmActionJitPluginData:o,jitPluginData:(z=c.metadata)==null?void 0:z.jit_plugin_data,invokedPlugin:void 0,fileAttachments:void 0};if((m==null?void 0:m.type)==="oauth_required"&&t)return{uiState:u.OauthLogin,lastConfirmActionJitPluginData:o,jitPluginData:(V=c.metadata)==null?void 0:V.jit_plugin_data,invokedPlugin:void 0,fileAttachments:void 0};if((m==null?void 0:m.type)==="link_required"&&t)return{uiState:u.NoAuthLink,lastConfirmActionJitPluginData:o,jitPluginData:(q=c.metadata)==null?void 0:q.jit_plugin_data,invokedPlugin:void 0,fileAttachments:void 0}}return{uiState:t?u.Running:u.Stopped,lastConfirmActionJitPluginData:o,jitPluginData:void 0,invokedPlugin:void 0,fileAttachments:void 0}}function be(e,t,n,i){var _,v,y,A,k,b,M,S,j,w;const o=(_=ne(e,n))!=null?_:void 0;if(!o)return{connectorId:void 0,connectorToolStatus:null,connectorStatusMessage:null,showConnectorConnect:!1};if(t===e)return{connectorId:o,connectorToolStatus:null,connectorStatusMessage:null,showConnectorConnect:!1};let r=p.Running,a=null,f=!1;const d=n[n.length-1],s=(v=d==null?void 0:d.metadata)==null?void 0:v.jit_plugin_data;return n.some(R=>R.content.content_type===C.SystemError)?(r=p.Error,a=h.error):d?((y=s==null?void 0:s.from_server)==null?void 0:y.type)==="oauth_required"&&i?(r=p.Paused,a=null,f=!0):((A=s==null?void 0:s.from_server)==null?void 0:A.type)==="link_required"&&i?(r=p.Paused,a=null,f=!0):(((k=s==null?void 0:s.from_server)==null?void 0:k.type)==="oauth_required"||((b=s==null?void 0:s.from_server)==null?void 0:b.type)==="link_required")&&!i?(r=p.Stopped,a=h.connectorDeclined):((M=s==null?void 0:s.from_client)==null?void 0:M.type)==="deny"?(r=p.Stopped,a=h.connectorDeclined):((S=s==null?void 0:s.from_client)==null?void 0:S.type)==="oauth_success"?(r=p.Stopped,a=null):((j=s==null?void 0:s.from_client)==null?void 0:j.type)==="link_success"?(r=p.Stopped,a=null):(w=d==null?void 0:d.metadata)!=null&&w.invoked_plugin?(r=p.Finished,a=h.finished):(r=p.Stopped,a=h.stopped):(r=p.Running,a=h.running),{connectorId:o,connectorToolStatus:r,connectorStatusMessage:a,showConnectorConnect:f}}function me({recipient:e,actionData:t,gizmoId:n}){return{id:ce(),author:{role:F.Tool,name:e},content:{content_type:C.Text,parts:[""]},recipient:"all",metadata:{jit_plugin_data:{from_client:t},gizmo_id:n},clientMetadata:{completionSampleFinishTime:Date.now()}}}function Me(a){var f=a,{clientThreadId:e,actionData:t,assistantMessage:n,onRequestCompletion:i,activeSystemHint:o}=f,r=Y(f,["clientThreadId","actionData","assistantMessage","onRequestCompletion","activeSystemHint"]);var s;const d=(s=ie(e))==null?void 0:s.mode;i(Q(O({},r),{promptMessage:me({recipient:n.recipient,actionData:t,gizmoId:d&&"gizmo_id"in d?d.gizmo_id:void 0}),completionMetadata:{conversationMode:d!=null?d:{kind:oe.PrimaryAssistant},systemHints:o?[o]:void 0}}))}function Se(e,t){if(e.type!==te.JIT_PLUGIN||!e.metadata.json_schema)return!1;let n=!1;function i(o){for(const r in o)r==="operationId"&&o[r]===t&&(n=!0),o[r]&&typeof o[r]=="object"&&i(o[r])}return i(e.metadata.json_schema),n}function P(e){var t,n,i;if(e&&(((t=e.from_server)==null?void 0:t.type)==="confirm_action"||((n=e.from_server)==null?void 0:n.type)==="oauth_required"||((i=e.from_server)==null?void 0:i.type)==="preview"))return e.from_server.body.params}function T(e){var t,n,i;if(e&&(((t=e.from_server)==null?void 0:t.type)==="confirm_action"||((n=e.from_server)==null?void 0:n.type)==="preview"))return(i=e.from_server.body.tool_call_safety_summary)!=null?i:void 0}function le(e){const t=re(e);if(t)try{return JSON.parse(t)}catch(n){return{text:t}}}function je(e,t){var r,a;const{assistantMessage:n}=x(e),{jitPluginData:i,lastConfirmActionJitPluginData:o}=N(e,t);return(a=(r=P(i))!=null?r:P(o))!=null?a:le(n)}function we(e,t){var o,r;const{jitPluginData:n,lastConfirmActionJitPluginData:i}=N(e,t);return(r=(o=T(n))!=null?o:T(i))!=null?r:void 0}function _e(e){if(!e)return;const t=e.content.content_type===C.Text?e.content.parts[0]:e.content.content_type===C.Code?e.content.text:void 0;if(t)try{return JSON.parse(t)}catch(n){return t}}const Ce=e=>{const{lastToolMessage:t}=x(e);return _e(t)},Ne=(e,t)=>{var i,o,r,a;const{jitPluginData:n}=N(e,t);return((i=n==null?void 0:n.from_server)==null?void 0:i.type)==="confirm_action"?(a=(r=(o=n==null?void 0:n.from_server)==null?void 0:o.body)==null?void 0:r.offer_remember_answer)!=null?a:!0:!1},pe=(e,t)=>{var i,o;const{jitPluginData:n}=N(e,t);return((i=n==null?void 0:n.from_server)==null?void 0:i.type)!=="denied_by_user"&&!!((o=n==null?void 0:n.from_server)!=null&&o.body.actions.length)},Re=(e,t)=>ae(e)&&pe(e,t);export{u as J,Ne as a,je as b,Re as c,Se as d,be as e,fe as f,N as g,Me as h,h as i,we as j,Ce as k,Ae as l,ke as m,x as p};
//# sourceMappingURL=fe8pomto0j6jsca5.js.map
