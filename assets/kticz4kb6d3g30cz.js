var yt=Object.defineProperty;var et=Object.getOwnPropertySymbols;var At=Object.prototype.hasOwnProperty,vt=Object.prototype.propertyIsEnumerable;var nt=(t,e,n)=>e in t?yt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,ot=(t,e)=>{for(var n in e||(e={}))At.call(e,n)&&nt(t,n,e[n]);if(et)for(var n of et(e))vt.call(e,n)&&nt(t,n,e[n]);return t};import{r as M,j as h}from"./i8clt0mfz495j7ii.js";import{n4 as B,n5 as j,u3 as st,nn as St}from"./j0yo6uv6652vva62.js";import{C as Pt,d as Mt,e as ut,E as Dt,f as bt}from"./cb0ba83bmi83mjz2.js";import{C as rt}from"./lo4w8zafp8iqjpvk.js";import{Z as ft}from"./ce3hgmw4iyyhicud.js";import{C as Nt,c as U,g as Bt}from"./go502v54gisfd23y.js";import{u as V,i as dt}from"./jdfzk1zd468oela3.js";import{e_ as mt,d_ as kt,aW as X,aV as R,d as W,r6 as wt,a$ as Tt,cE as z,dd as $,a as Yt,gV as _t}from"./ghewn7l2ynbm32fm.js";import{u as jt,d as k,f as pt,C as N,S as Ht,e as q}from"./6ji8ehbh56ghw0zw.js";import{g as ht,b as Et,a as It}from"./kau2ug0899cbkpxh.js";import{P as Rt,H as Gt}from"./o9vew0btr2k0i59c.js";import{G as D,T as ct}from"./dxyrjy681bkwlnj8.js";import{u as Ct}from"./mqebxepg7t6q2tie.js";var w=(t=>(t[t.up=-1]="up",t[t.down=1]="down",t))(w||{}),G=(t=>(t.COMMENT="comment",t.COMPOSER="composer",t))(G||{}),v=(t=>(t.COLLAPSED="collapsed",t.EXPANDED="expanded",t))(v||{});const gt=([t,e],[n,o])=>{const s=t+e,c=n+o;return t<c&&n<s},Z=([t,e])=>t+e,Y=t=>{var c;if(t.type===v.COLLAPSED)return[(c=t.offsetY)!=null?c:0,0];const{offsetY:e,shiftY:n=0,height:o=0}=t,s=e+n;return n<0?[s,o+Math.abs(n)]:[s,o]},Vt=(t,e,n)=>{if(!gt(t,e))return null;const[o,s]=t,c=o+s,[r,i]=e,l=r+i,u=r-c,m=l-o;return n===w.up?u:m};function Xt(t,e,n){const o=t+e;for(const s of n.values()){const c=s.start,r=s.end;if(t<r&&c<o)return!0}return!1}const Kt=50,Ut=200,Ft=[Rt.proseMirrorNodeName(),Gt.proseMirrorNodeName()],Wt=t=>t?t.isBlock:!1,zt=t=>{if(!t)return!1;const{isBlock:e,type:{name:n}}=t;return e&&Ft.includes(n)},$t=(t,e,n,o)=>{const s=t.posAtCoords({left:e,top:n});if(s==null)return;const{pos:c,inside:r}=s;if(r===-1)return;const{state:i}=t;let l=c,u=i.doc.nodeAt(l);for(;!Wt(u)&&l>=0;)l--,u=i.doc.nodeAt(l);if(!u||!zt(u))return;const m=o!=null&&Xt(l,u.nodeSize,o);return{node:u,nodeHasComment:m,pos:l}};function Zt(t,e,n){const o=$t(t,e.x,e.y,n);if(o==null)return null;const{node:s,pos:c,nodeHasComment:r}=o,{top:i}=t.coordsAtPos(0);function l(){const d=c+1;if(It(t.state.doc,d)){const f=t.state.doc.nodeAt(d);if(f!=null&&f.isText)return t.coordsAtPos(d).top}return t.coordsAtPos(c).top}const u=l(),m=u-i;return{height:t.coordsAtPos(c+s.nodeSize-1).bottom-u,nodeHasComment:r,mouseEnteredAt:Date.now(),yOffset:m,pos:c}}function qt(t){var E;const e=M.useRef(!1),n=M.useRef(!1),[o,s]=M.useState(null),c=jt(),r=(E=c())==null?void 0:E.dom,i=M.useRef(!1),l=k(({visibleBlockCommentLauncher_DEBUG_ONLY:a})=>a),u=M.useCallback(mt(a=>{var P;e.current=!0;const{commentingOn:d}=k.getState();if(n.current||d!=null)return;const f=c();if(f==null||!e.current)return s(null);const{dom:A,state:C}=f,p=(P=ht(Et,C))==null?void 0:P.positions;if(p==null)return s(null);const g=Zt(f,a,p);if(g==null||g.nodeHasComment&&t===D.COLLAPSED){s(null);return}if(i.current&&g.yOffset!==(o==null?void 0:o.yOffset)){s(null);return}const S=f.coordsAtPos(0),L=A.getBoundingClientRect().width,x=(a.x-S.left)/L>=Kt/100;s(x?g:null)},Ut),[c,i,o]);M.useEffect(()=>{if(r!=null)return kt(r,{mouseenter:()=>{e.current=!0,n.current=!1},mouseleave:({relatedTarget:a})=>{if(u.cancel(),a instanceof HTMLElement&&a.closest("[data-block-comment-launcher]")){n.current=!0;return}n.current=!1,e.current=!1,k.getState().commentingOn==null&&s(null)},mousemove:u})},[c,r,t,u]);const m=M.useCallback(({relatedTarget:a})=>{const{commentingOn:d}=k.getState();d==null&&a!==r&&(n.current=!1,s(null))},[r]);return{visibleBlockComment:l!=null?l:o,handleMouseLeave:m,onComposerVisibleChange:a=>{i.current=a}}}const Jt=({isWaitingForCommentResponse:t=!1,opensOverDocument:e=!1,hasComments:n=!1,activeBlockComment:o,composerRef:s,onLaunchComposer:c,onMouseLeave:r,onSubmit:i})=>{const[l,u]=M.useState(!1),{yOffset:m,height:E,pos:a}=o,d=()=>{u(!0),c==null||c(),B.logButtonClick(j.BLOCK_COMMENT_LAUNCHER),N.startCommentingOn({type:q.BLOCK,pos:a})},f=p=>{p||(u(!1),N.cancelCommentingOn())},A=(p,g)=>{u(!1),i==null||i(p,g)};M.useEffect(()=>()=>{N.mouseLeaveBlock()},[]);const C=n&&l?e?-88:88:0;return h.jsx(R.div,{className:W("pointer-events-auto absolute flex h-6 w-5 origin-[14px_50%] items-start after:absolute after:-inset-4 after:content-['']",ft.commentComposer),initial:!1,animate:{opacity:1},exit:{opacity:0},transition:{type:"spring",duration:.2,bounce:.1},style:{top:0,height:E,translateY:m},onMouseLeave:r,"data-block-comment-launcher":!0,children:h.jsxs(X,{children:[l?h.jsx(Nt,{ref:s,opensFromGutter:!0,onClose:f,onSubmit:A,gutterHasComments:n,opensOverDocument:e},"composer"):null,h.jsx(R.button,{initial:{opacity:0},animate:{opacity:l?0:1,translateX:C},transition:{duration:.15,translateX:{type:"spring",bounce:.18,duration:.48}},className:"group absolute z-10 flex h-6 gap-1 bg-transparent after:absolute after:-inset-y-4 after:-start-1 after:-end-4 after:content-['']",onClick:d,onMouseEnter:()=>N.mouseEnterBlock(a),onMouseLeave:()=>N.mouseLeaveBlock(),disabled:l||t,children:h.jsx(Pt,{isLoading:t})},"launcer")]})})},Qt=({isWaitingForCommentResponse:t=!1,isRequestActive:e=!1,hasComments:n=!1,composerRef:o,gutterMode:s,onAddComment:c})=>{const r=pt(),{visibleBlockComment:i,handleMouseLeave:l,onComposerVisibleChange:u}=qt(s),m=(E,a)=>{if(!i||!r)return;const{doc:d}=r,{pos:f}=i,A=d.nodeAt(f);if(!A)return;const{attrs:{start:C,end:p}}=A;c==null||c(E,a,Ht.ASK,{start:C,end:p},q.BLOCK)};return h.jsx(X,{onExitComplete:()=>u(!1),children:i&&r&&(t||!e)&&h.jsx(Jt,{composerRef:o,isWaitingForCommentResponse:t,opensOverDocument:s===D.COLLAPSED,activeBlockComment:i,hasComments:n,onSubmit:m,onMouseLeave:l,onLaunchComposer:()=>u(!0)},"launcher")})},te=({onAcceptComment:t,onDismissComment:e,disableActions:n=!1,entry:o,isGutterCollapsed:s=!1,isHovered:c=!1,isFocused:r=!1,isSomeCommentFocused:i=!1})=>{const{offsetY:l,type:u}=o,[m,E]=wt();let a=null;if(u===v.COLLAPSED)a=!r&&h.jsx(Mt,{offsetY:l,count:o.count,onClick:()=>{B.logButtonClick(j.COLLAPSED_COMMENT),N.focusComment(o.children[0])}},"collapsed");else{const{comment:d}=o;if(d==null||d.content===""||d.status===st.DISMISSED)a=null;else if(d.status===st.ACCEPT_INITIATED)a=h.jsx("div",{className:"absolute",style:{top:l},children:h.jsx(ut,{})},"loading");else{const{id:f}=d;a=h.jsx(Dt,{isSomeCommentFocused:i,isHovered:c,isFocused:r,offsetY:l,disableActions:n,onClick:()=>{B.logButtonClick(j.EXPANDED_COMMENT),N.focusComment(f)},onMouseEnter:()=>N.mouseEnterComment(f),onMouseLeave:()=>N.mouseLeaveComment(),comment:d,onAccept:A=>{B.logButtonClick(j.COMMENT_ACCEPT,{commentId:f}),t==null||t(A,f)},onDismiss:()=>{B.logButtonClick(j.COMMENT_DISMISS,{commentId:f}),e==null||e(f)},opensOverDocument:s},"expanded")}}return h.jsx(X,{onExitComplete:()=>E==null?void 0:E(),children:m&&a})},it=({onMeasureHeight:t,comment:e,isFocused:n=!1})=>{const[{height:o},s]=Ct();return Tt(()=>{t==null||t(o)},[o]),h.jsx(bt,{ref:s,comment:e,isFocused:n,disableAnimations:!0})},ee=({comments:t,onMeasure:e,getStableCommentId:n})=>{const o=M.useRef(new Map),s=M.useRef(new Map),c=M.useRef(null),r=(i,l,u=!1)=>{l&&(u?s.current.set(n(i),l):o.current.set(n(i),l),c.current&&cancelAnimationFrame(c.current),c.current=requestAnimationFrame(()=>{e==null||e({focusedHeights:new Map(s.current),heights:new Map(o.current)}),c.current=null}))};return t!=null&&t.length?h.jsxs("div",{className:"pointer-events-none invisible fixed start-0 top-0 overflow-clip","aria-hidden":"true",children:[t.map(i=>h.jsx(it,{comment:i,onMeasureHeight:l=>r(i.id,l)},n(i.id))),t.map(i=>h.jsx(it,{isFocused:!0,comment:i,onMeasureHeight:l=>r(i.id,l,!0)},"".concat(n(i.id),"-focused")))]}):null},lt=(t,e,n)=>{let o=n+e;for(;e===w.down?o<t.length:o>-1;){const s=t[o],c=t[o-e],r=Vt(Y(s),Y(c),e);if(r!=null&&s.type!==v.COLLAPSED)s.shiftY+=r;else break;o+=e}},at=(t,e)=>{for(const n of e){const{index:o,amount:s}=n,c=t[o];c.type===v.EXPANDED&&(c.shiftY+=s),lt(t,w.down,o),lt(t,w.up,o);for(const r of t)r.type!==v.COLLAPSED&&(r.offsetY+=r.shiftY,r.shiftY=0)}},ne=(t,e)=>{const n=[],[o,s]=e,c=o+s;for(let r=0;r<t.length;r++){const i=t[r],[l]=Y(i),u=[l,i.type===v.EXPANDED?i.height:0],[m,E]=u;if(gt(u,e)){const a=m+E,d=o-a,f=c-m,C=(Math.abs(d)<Math.abs(f)?w.up:w.down)===w.up?d:f;n.push({index:r,amount:C})}}return n},oe=({gutterMode:t,focusedCommentId:e,gutterPositions:n,getCommentKey:o,getComment:s})=>{var m,E,a,d,f,A;if(!(n!=null&&n.size))return[];const c=new Map,r=[];let i=null,l=-1;for(const C of n.values()){if(C.type===G.COMPOSER){i=[C.offsetY,C.height];continue}const{commentId:p,height:g,collapsedOffsetY:S,offsetY:L}=C;if(t===D.EXPANDED){const P=z(r),b=P?Z(Y(P)):0;let y=L;P&&y<=b&&(y=b),c.set(p,{originalOffsetY:L,offsetY:y}),e===p&&(l=r.length),r.push({key:o(p),comment:s(p),type:v.EXPANDED,height:g,offsetY:y,shiftY:0});continue}let O=r.findIndex(({offsetY:P,type:b})=>b===v.COLLAPSED&&P===S),x=(m=r[O])!=null?m:null;if(!x)x={key:r.length,type:v.COLLAPSED,offsetY:L,count:1,children:[p]},O=r.length,r.push(x);else{if(x.type!==v.COLLAPSED)throw new Error("Collapsed parent type expected to be collapsed");x.count+=1,x.children.push(p),x.offsetY=S}e===p&&(l=O)}const u=r[l];if(t===D.COLLAPSED&&(u==null?void 0:u.type)===v.COLLAPSED){const C=[];for(let p=0;p<u.children.length;p++){const g=u.children[p];g===e&&(l+=p+1);const S=z(C),L=S?Z(Y(S)):0,O=(a=(E=n.get(g))==null?void 0:E.offsetY)!=null?a:0,x=Math.max(L,O);c.set(g,{originalOffsetY:O,offsetY:x}),C.push({type:v.EXPANDED,key:o(g),comment:s(g),offsetY:x,height:(f=(d=n.get(g))==null?void 0:d.height)!=null?f:0,shiftY:0})}r.splice(l,0,...C)}if(e){const C=c.get(e);if(!C)return r;const{offsetY:p,originalOffsetY:g}=C,S=g-p,L=[{amount:S,index:l}];let O=l+1;for(;O<r.length;){const x=r[O],{type:P}=x;let b=S;if(P===v.EXPANDED&&((A=x.comment)!=null&&A.id)){const{offsetY:y,originalOffsetY:_}=$(c.get(x.comment.id));if(y===_)break;b=Math.max(_-y,S)}else break;L.push({amount:b,index:O}),O++}L.length&&at(r,L)}else if(t!==D.COLLAPSED&&i){const C=ne(r,i);at(r,C)}return r},se=t=>{try{return oe(t)}catch(e){return B.logError("Generating comment gutter entries",e),[]}},re=t=>"length"in t?t.length===0:t.nodeSize===0,F=12,ce=({composerHeight:t,getCommentHeight:e,getCollapsedStartPos:n,commentingOn:o,commentPositions:s,view:c})=>{var u,m;if(!s||!c||re(c.state.doc))return null;const{top:r}=c.dom.getBoundingClientRect(),i=Array.from(s.entries()).sort(([E,a],[d,f])=>a.start-f.start),l=new Map;for(const[E,{start:a}]of i)try{const d=(u=n==null?void 0:n(a))!=null?u:a,{top:f}=U(c,d),{top:A}=U(c,a),C=A-r,p=f-r,g=((m=e(E))!=null?m:0)+F;l.set(E,{commentId:E,height:g,collapsedOffsetY:p,offsetY:C,type:G.COMMENT})}catch(d){continue}if((o==null?void 0:o.type)===q.BLOCK){const{pos:E}=o;try{const{top:a}=U(c,E),f=a-r-F;l.set("block-composer",{type:G.COMPOSER,height:(t!=null?t:0)+F,offsetY:f})}catch(a){}}return l},Lt=(t,e)=>{const n=e.nodeAt(t);return n!=null&&n.isBlock?t+1:Lt(t-1,e)};function ie(t){const e=pt(),n=V(),o=n==null?void 0:n();if(!o)return null;if(dt(o)){if(!e)return null;const s=ht(Et,e);return s?s.positions:null}return new Map(t.map(s=>[s.id,s.at]))}const le=({gutterMode:t,focusedCommentId:e,commentingOn:n,comments:o,getStableId:s})=>{const[{height:c},r]=Ct(),i=V(),[l,u]=M.useState(()=>new Map),[m,E]=M.useState(()=>new Map),a=M.useCallback(({focusedHeights:L,heights:O})=>{u(L),E(O)},[]),d=L=>{var x,P;const O=s(L);return L===e?(x=l.get(O))!=null?x:0:(P=m.get(O))!=null?P:0},f=i(),A=f!=null&&dt(f)?(L=>Lt(L,f.state.doc)):void 0,C=new Map(o==null?void 0:o.map(L=>[s(L.id),L])),p=ie(o),g=ce({composerHeight:c,commentingOn:n,getCommentHeight:d,getCollapsedStartPos:A,commentPositions:p,view:f}),S=se({gutterMode:t,gutterPositions:g,focusedCommentId:e,getComment:L=>{var O;return(O=C.get(s(L)))!=null?O:null},getCommentKey:s});return{blockComposerRef:r,onMeasureComments:a,gutterEntries:S}};function ae(){const e=V()(),n=k(({commentingOn:c})=>c),s=e==null?null:Bt(e,n);return s==null?null:h.jsx(R.div,{className:"absolute",style:{top:s.loadingTop},initial:!1,animate:{opacity:1,scale:1},exit:{opacity:0,scale:0},transition:{delay:.2},children:h.jsx(ut,{})},"selection-loading")}const ue=t=>h.jsx("div",{className:"absolute",style:{top:Z(Y(t))},children:h.jsx("div",{className:"h-[max(3rem,18vh)] w-1"})}),Pe=({availableWidth:t,comments:e,commentsMode:n,disableBlockComments:o=!1,isRequestActive:s=!1,isWaitingForCommentResponse:c=!1,onAddComment:r,onAcceptComment:i,onDismissComment:l,getStableCommentId:u})=>{const m=k(({focusedCommentId:y})=>y),E=k(({hoveredCommentId:y})=>y),a=k(({commentingOn:y})=>y),d=Yt(_t),f=t<ct?D.COLLAPSED:D.EXPANDED,{onMeasureComments:A,blockComposerRef:C,gutterEntries:p}=le({comments:e,getStableId:u,gutterMode:f,focusedCommentId:m,commentingOn:a}),g=p.length>0,S=a!=null&&!c&&a.type!=="selection"||g,O=(()=>{if(!S)return 0;switch(f){case D.COLLAPSED:return 0;case D.EXPANDED:return ct}})(),x=(a==null?void 0:a.type)==="selection",P=z(p),b=n===rt.ENABLED&&d&&!x&&!o;return h.jsxs(R.div,{className:W("pointer-events-none relative flex h-full shrink-0",ft.commentGutter,f===D.COLLAPSED&&O?"basis-[32px]":"basis-0"),initial:{width:0,opacity:0},animate:{width:O,opacity:1},exit:{width:0,opacity:0},children:[h.jsx(ee,{getStableCommentId:u,comments:e,onMeasure:A}),h.jsxs("div",{className:W("pointer-events-auto absolute start-0 top-0 bottom-0 w-0 overflow-visible",{"ps-2":S||!o}),children:[h.jsx(X,{children:p.map(y=>{var Q,tt;const{key:_,type:J}=y,Ot=!!m&&J===v.EXPANDED&&((Q=y.comment)==null?void 0:Q.id)===m,xt=!!m&&y.type===v.COLLAPSED&&y.children.includes(m);return h.jsx(te,{isGutterCollapsed:f===D.COLLAPSED,isSomeCommentFocused:!!a||!!m,isHovered:J===v.EXPANDED&&((tt=y.comment)==null?void 0:tt.id)===E,isFocused:Ot||xt,entry:y,disableActions:s||c||n===rt.COMMENTS_READONLY,onAcceptComment:(H,T)=>{try{i==null||i(H,$(e==null?void 0:e.find(K=>K.id===T)))}catch(K){B.logError("Comment ".concat(T," not found"),K)}},onDismissComment:H=>{try{l==null||l($(e==null?void 0:e.find(T=>T.id===H)))}catch(T){B.logError("Comment ".concat(H," not found"),T)}}},_)})}),g&&P&&h.jsx(ue,ot({},P)),b&&h.jsx(Qt,{composerRef:C,gutterMode:f,onAddComment:r,isWaitingForCommentResponse:c,isRequestActive:s,hasComments:g}),c&&x&&h.jsx(ae,{})]})]})};function fe(t){let e=t;for(;e;){const o=window.getComputedStyle(e).overflowY;if(o==="auto"||o==="scroll")return e;e=e.parentElement}return null}function Me(t,e){const n=V(),o=St(),s=n();M.useEffect(()=>{const c=s==null?void 0:s.dom;if(!c||t.length===0)return;const r=fe(c),i=e?mt(e,100):null;return r&&i&&r.addEventListener("scroll",i,{passive:!0}),()=>{i&&(r&&r.removeEventListener("scroll",i),i.cancel())}},[s,o,t,e])}let I=null;function De(){if(I!=null)return I;if(typeof window>"u")return 0;const t=document.createElement("div");t.style.width="100px",t.style.height="100px",t.style.overflow="scroll",t.style.position="absolute",t.style.top="-9999px",document.body.appendChild(t);try{I=t.offsetWidth-t.clientWidth}finally{document.body.removeChild(t)}return I}function be(t){return t==null?null:t.scrollHeight>t.clientHeight}export{Pe as C,re as a,De as g,be as i,Me as u};
//# sourceMappingURL=kticz4kb6d3g30cz.js.map
